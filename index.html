<!DOCTYPE html>
<html lang="zh-TW">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>ğŸ‡³ğŸ‡´ Norway â„ï¸</title>
    <link rel="stylesheet" href="leaflet/leaflet.css"> 
    <script src="leaflet/leaflet.js"></script>

   <style>
       /* ==================================== */
       /* è«è˜­è¿ªè‰²ç³» CSS æ¨£å¼ (æ‰‹æ©ŸéŸ¿æ‡‰å¼å„ªåŒ–) */
       /* ==================================== */
       
       /* åŸºç¤è¨­å®šï¼šä½¿ç”¨ box-sizing è®“ä½ˆå±€æ›´ç›´è§€ */
       *, *::before, *::after {
           box-sizing: border-box;
       }

       body {
           font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
           background-color: #f7f7f7; /* <-- æ¥µæ·ºä¸­æ€§ç° */
           color: #333;
           margin: 0;
           /* éŸ¿æ‡‰å¼å„ªåŒ– */
           padding: 1rem;
           font-size: 16px; 
       }

       /* åœ¨è¼ƒå°è¢å¹•ä¸Šå°‡åŸºç¤å­—é«”ç¨å¾®ç¸®å° */
       @media (max-width: 600px) {
           body {
               font-size: 14px;
               padding: 0.5rem;
           }
       }

       .container {
           max-width: 900px;
           margin: 0 auto;
           background-color: #ffffff;
           padding: 30px;
           border-radius: 8px;
           box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
           position: relative;
           z-index: 200;
       }
       
       /* ç¢ºä¿æ‰‹æ©Ÿä¸Šé‚Šè·ä¸æœƒéå¤§ */
       @media (max-width: 600px) {
           .container {
               padding: 15px;
           }
       }

       h1 {
           color: #4a6984;
           text-align: center;
           border-bottom: 3px solid #4a6984;
           padding-bottom: 15px;
           margin-bottom: 30px;
       }

       /* --- è²»ç”¨è¼¸å…¥å€å¡Šæ¨£å¼ --- */
       .input-form {
           background-color: #f7f4e9;
           padding: 20px;
           border-radius: 5px;
           margin-top: 30px;
           margin-bottom: 30px;
           display: flex;
           gap: 15px;
           flex-wrap: wrap;
           align-items: flex-end;
       }

       .form-group {
           display: flex;
           flex-direction: column;
       }
       /* æ‰‹æ©Ÿä¸Šè¡¨å–®å…ƒç´ ä½”æ»¿ä¸€è¡Œ */
       @media (max-width: 600px) {
           .input-form .form-group {
               width: 100% !important; /* è¦†è“‹ inline width */
               flex-shrink: 1 !important;
           }
       }

       .form-group label {
           font-weight: bold;
           margin-bottom: 5px;
           color: #4a6984;
           font-size: 0.9em;
       }

       .input-form input, .input-form select,
       /* ç¢ºä¿ itinerary-manager å…§çš„ input æ¨£å¼ä¸€è‡´ */
       .itinerary-manager input, .itinerary-manager select {
           padding: 10px;
           border: 1px solid #c9d2d6;
           border-radius: 4px;
           font-size: 1em;
           width: 100%;
           box-sizing: border-box;
       }

       .add-button {
           padding: 10px 20px;
           background-color: #9b7673;
           color: white;
           border: none;
           border-radius: 4px;
           cursor: pointer;
           font-weight: bold;
           transition: background-color 0.3s;
           min-width: 100px;
       }
       /* æ‰‹æ©Ÿä¸Šæ–°å¢æŒ‰éˆ•ä½”æ»¿ä¸€è¡Œ */
       @media (max-width: 600px) {
           .input-form .add-button {
               width: 100%;
           }
       }

       .add-button:hover {
           background-color: #7d605e;
       }

       /* --- è¡Œç¨‹ç®¡ç†å€å¡Šæ¨£å¼ (é©æ‡‰ Tab å…§å®¹) --- */
       .itinerary-manager {
           /* ç•¶ä½œ Tab å…§å®¹ä¸­çš„ä¸€å€‹å€å¡Šï¼Œä½¿ç”¨æŸ”å’ŒèƒŒæ™¯èˆ‡é‚Šæ¡† */
           background-color: #f7f4e9;
           padding: 20px;
           border-radius: 5px;
           border: 1px solid #e0e7e8;
       }

       .itinerary-manager h2 {
           margin-top: 0;
           background-color: #4a6984 !important;
           color: white !important;
           border-left: 5px solid #2e4d69;
           cursor: default;
           padding: 12px 15px;
           border-radius: 5px;
       }

       .manager-group {
           margin-bottom: 15px;
       }

       .manager-group label {
           font-weight: bold;
           display: block;
           margin-bottom: 5px;
           color: #9b7673;
       }

       .manager-group .input-row {
           display: flex;
           gap: 10px;
           flex-wrap: wrap; /* å…è¨±æ›è¡Œ */
       }
       /* æ‰‹æ©Ÿä¸Šï¼Œselect å…ƒç´ æ‡‰è©²ä½”æ»¿ä¸€è¡Œï¼Œä½†ä¿ç•™å½ˆæ€§ */
       @media (max-width: 600px) {
           .manager-group .input-row select,
           .manager-group .input-row input {
               min-width: 100%; /* å¼·åˆ¶ä½”æ»¿ */
           }
       }


       /* --- è²»ç”¨å¡ç‰‡æ¨£å¼ --- */
       .expense-list {
           display: flex;
           flex-direction: column;
           gap: 10px;
           margin-bottom: 20px;
       }

       .expense-card {
           display: flex;
           align-items: center;
           background-color: #f8f8f8;
           border: 1px solid #c9d2d6;
           border-radius: 5px;
           padding: 15px;
           box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
       }
       /* æ‰‹æ©Ÿä¸Šå¡ç‰‡å„ªåŒ– */
       @media (max-width: 480px) {
           .expense-card {
               flex-wrap: wrap;
           }
           .card-main-info {
               flex-basis: 100%; /* ä¸»è³‡è¨Šä½”æ»¿ä¸€è¡Œ */
               margin-bottom: 10px;
           }
           .card-amounts {
               text-align: left;
               margin-left: 0;
           }
           .delete-card-btn {
               margin-left: auto; /* é å³å°é½Š */
           }
       }

       .card-icon {
           font-size: 2em;
           margin-right: 15px;
           flex-shrink: 0;
       }

       .card-main-info {
           flex-grow: 1;
       }

       .card-description {
           font-weight: bold;
           color: #333;
           margin-bottom: 3px;
       }

       .card-meta {
           font-size: 0.9em;
           color: #666;
       }

       .card-amounts {
           text-align: right;
           margin-left: 15px;
           flex-shrink: 0;
       }

       .amount-ntd {
           font-size: 1.2em;
           color: #9b7673;
           font-weight: bold;
       }

       .amount-nok {
           font-size: 0.9em;
           color: #4a6984;
       }

       .delete-card-btn {
           background-color: #c97c77;
           color: white;
           border: none;
           padding: 8px 10px;
           margin-left: 10px;
           cursor: pointer;
           border-radius: 3px;
           font-size: 0.9em;
           transition: background-color 0.3s;
           flex-shrink: 0;
       }

       .delete-card-btn:hover {
           background-color: #a86460;
       }

       /* --- è²»ç”¨ç¸½è¨ˆèˆ‡ç¯©é¸å·¥å…·æ¨£å¼ --- */
       .cost-summary {
           background-color: #f0ede5;
           padding: 15px;
           border-radius: 5px;
           display: flex;
           justify-content: space-between;
           align-items: center;
           font-size: 1.1em;
           font-weight: bold;
           margin-bottom: 20px;
       }
       /* æ‰‹æ©Ÿä¸Šç¸½è¨ˆé¡¯ç¤ºæ›è¡Œ */
       @media (max-width: 400px) {
           .cost-summary {
               flex-direction: column;
               align-items: flex-start;
               gap: 5px;
           }
       }

       .total-amount-display {
           color: #9b7673;
           font-size: 1.5em;
       }

       .filter-sort-bar {
           display: flex;
           gap: 10px;
           align-items: center;
           margin-bottom: 15px;
           background-color: #f0f7f9;
           padding: 10px;
           border-radius: 5px;
           flex-wrap: wrap; /* å…è¨±æ›è¡Œ */
       }

       .filter-sort-bar label {
           font-weight: normal;
           color: #4a6984;
           flex-shrink: 0;
       }
       /* è®“ select åœ¨æ‰‹æ©Ÿä¸Šä½”æ»¿ä¸€è¡Œ */
       @media (max-width: 480px) {
           .filter-sort-bar select {
               width: 100%;
               margin-top: 5px;
           }
       }

       .filter-sort-bar select {
           padding: 8px;
           border-radius: 4px;
           border: 1px solid #c9d2d6;
           flex-grow: 1;
       }

       /* --- æ”¯å‡ºçµ±è¨ˆè¡¨æ ¼æ¨£å¼ --- */
       .stats-table {
           width: 100%;
           border-collapse: collapse;
           font-size: 1em;
           text-align: left;
           margin-top: 15px;
       }

       .stats-table th, .stats-table td {
           border: 1px solid #c9d2d6;
           padding: 10px;
       }

       .stats-table th {
           background-color: #4a6984;
           color: white;
           font-weight: bold;
           text-align: center;
       }

       .stats-table tr:nth-child(even) {
           background-color: #f0f7f9;
       }

       .stats-table .total-row td {
           background-color: #f7e1e1;
           font-weight: bold;
           color: #9b7673;
           font-size: 1.1em;
       }

       .stats-table .percentage-cell {
           text-align: right;
       }

       /* ==================================== */
       /* æ©«å‘æ¨™ç±¤é  (Tabs) æ¨£å¼ */
       /* ==================================== */

       .tab-bar {
           display: flex;
           overflow-x: auto;
           white-space: nowrap;
           border-bottom: 2px solid #9b7673;
           margin-bottom: 0;
           padding-bottom: 0;
           user-select: none;
           -webkit-overflow-scrolling: touch;
       }

       .tab-button {
           padding: 10px 15px;
           cursor: pointer;
           background-color: #e0e7e8;
           color: #4a6984;
           border: 1px solid #c9d2d6;
           border-bottom: none;
           border-top-left-radius: 5px;
           border-top-right-radius: 5px;
           margin-right: 5px;
           transition: background-color 0.3s, color 0.3s;
           flex-shrink: 0;
           font-weight: bold;
           text-align: center;
           line-height: 1.3;
       }

       .tab-button.active {
           background-color: #ffffff;
           color: #9b7673;
           border-color: #9b7673;
           border-bottom: 2px solid #ffffff;
           z-index: 10;
           position: relative;
       }

       .tab-content {
           border: 1px solid #9b7673;
           padding: 20px;
           background-color: #ffffff;
           border-radius: 0 5px 5px 5px;
           margin-top: -1px;
           display: none;
           flex-direction: column;
           gap: 10px;
       }

       .tab-content.active {
           display: flex;
       }

       /* ==================================== */
       /* è¡Œç¨‹å¡ç‰‡æ¨£å¼ (å·²å„ªåŒ–) */
       /* ==================================== */

       .activity-card {
           display: flex; /* å•Ÿç”¨ Flexbox */
           flex-wrap: wrap; /* å…è¨±åœ¨ç©ºé–“ä¸è¶³æ™‚æ›è¡Œ */
           align-items: center; /* å‚ç›´å±…ä¸­å°é½Š */
           background-color: #f8f8f8;
           border: 1px solid #e0e7e8;
           border-left: 5px solid #4a6984;
           border-radius: 5px;
           padding: 10px 40px 10px 15px;
           box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
           gap: 10px; /* å¢åŠ å…ƒä»¶é–“è· */
           position: relative;
       }

       .card-time {
           /* è®“æ™‚é–“æ¬„ä½å›ºå®šå¯¬åº¦ï¼Œä¸ä½”ç”¨å¤ªå¤šç©ºé–“ */
           flex-shrink: 0;
           width: 60px; /* è¨­ç½®ä¸€å€‹å›ºå®šçš„æ™‚é–“å¯¬åº¦ */
           padding-bottom: 0;
           margin-bottom: 0; 
           /* ç§»é™¤é‚Šæ¡†ï¼Œè®“å¡ç‰‡æ›´ç°¡æ½” */
           border-bottom: none; 
           font-weight: bold;
           color: #4a6984;
           line-height: 1.4;
           font-size: 1.1em;
           outline: none;
           text-align: center;
       }
        
       .card-time[contenteditable="true"]:focus {
            box-shadow: 0 0 0 1px #e6e6fa;
            border-radius: 3px;
       }

       .card-activity-details {
           /* è®“å…§å®¹ç›¡å¯èƒ½ä½”æ»¿å‰©é¤˜ç©ºé–“ */
           flex-grow: 1; 
           display: flex;
           flex-direction: column;
           line-height: 1.4;
           min-width: 50%; /* ç¢ºä¿å…§å®¹åœ¨å°è¢å¹•ä¸Šå¯ä»¥ä½”æ“šè‡³å°‘ä¸€åŠå¯¬åº¦ */
       }

       /* å…§å®¹å¯ç·¨è¼¯å€å¡Šæ¨£å¼ - ç”¨æ–¼æ´»å‹•æè¿° */
       .editable-content {
           flex-grow: 1;
           padding: 0 5px;
           transition: box-shadow 0.2s;
           outline: none;
           cursor: text;
           margin-bottom: 5px;
           font-size: 1.1em;
           min-height: 1.2em;
       }

       .editable-content:focus {
           box-shadow: 0 0 0 2px #e6e6fa;
           border-radius: 3px;
       }

       /* åœ°åœ–é€£çµå®¹å™¨ */
       .card-map-links {
           display: flex;
           gap: 8px;
           margin-top: 5px;
       }

       a.map-link {
           color: #6a8ba2;
           font-size: 0.9em;
           text-decoration: none;
           font-weight: bold;
           cursor: pointer;
           flex-shrink: 0;
           line-height: 1;
           display: flex;
           align-items: center;
           padding: 3px 5px;
           border: 1px solid #d3d3e6;
           border-radius: 3px;
           background-color: #f0f7f9;
       }

       a.map-link:hover {
           background-color: #e0e7e8;
           color: #4a6984;
       }
       
       /* ç·¨è¼¯åœ°åœ–æŒ‰éˆ•ç‰¹åˆ¥æ¨£å¼ */
       a.map-link.edit-link {
           color: #9b7673;
           background-color: #f7e1e1; 
           border-color: #e1c4c4;
       }


       .delete-btn {
           background-color: #c97c77;
           color: white;
           border: none;
           padding: 5px 8px;
           position: absolute;
           top: 10px;
           right: 10px;
           cursor: pointer;
           border-radius: 3px;
           font-size: 0.9em;
           transition: background-color 0.3s;
           flex-shrink: 0;
       }

       .delete-btn:hover {
           background-color: #a86460;
       }

       /* ç‰¹æ®Šè¡Œç¨‹é …ç›®æ¨£å¼ - äº¤é€š/ä½å®¿ */
       .transport-item {
           border-left-color: #6a8ba2;
           background-color: #f0f7f9;
       }

       .lodging-item {
           border-left-color: #9b7673;
           background-color: #f9f0f0;
       }

       .highlight {
           font-weight: bold;
           color: #4a6984;
       }
       /* ==================================== */
       /* Packing List & Documents CSS */
       /* ==================================== */
       .packing-item, .document-item {
           display: flex;
           justify-content: space-between;
           align-items: center;
           padding: 10px;
           border-bottom: 1px dashed #eee;
           cursor: pointer;
           transition: background-color 0.1s;
       }
       .packing-item:hover, .document-item:hover {
           background-color: #f9f9f9;
       }
       .packing-item.checked {
          opacity: 0.6;
          background-color: #f0f0f0;
       }
       .packing-item.checked .card-description::before {
          content: "âœ… ";
          font-weight: bold;
       }
       .packing-item .card-main-info {
          cursor: pointer;
          flex-grow: 1;
       }
       .doc-link {
           color: #4a6984;
           text-decoration: none;
           font-weight: bold;
       }
       .document-list {
           display: flex;
           flex-direction: column;
           gap: 10px;
       }
       .document-card {
           background-color: #f0f7f9;
           border: 1px solid #c9d2d6;
           border-radius: 5px;
           padding: 15px;
           display: flex;
           justify-content: space-between;
           align-items: center;
           box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
           font-size: 1.1em;
       }
       .document-title {
           font-weight: bold;
           color: #4a6984;
           flex-grow: 1;
       }
   </style>
</head>
<body>

<div class="snow"></div>

<div class="container">
   <h1>ğŸ‡³ğŸ‡´ Norway â„ï¸</h1>

   <div id="itinerarySection" class="itinerary-section">
       <div class="tab-bar" id="tabBar">
           <button class="tab-button active" data-tab-id="expenses">ğŸ’° è²»ç”¨æ¸…å–®</button>
           <button class="tab-button" data-tab-id="day1">ğŸ—“ï¸ Day 1: 12/5</button>
           <button class="tab-button" data-tab-id="day2">ğŸ—“ï¸ Day 2: 12/6</button>
           <button class="tab-button" data-tab-id="day3">ğŸ—“ï¸ Day 3: 12/7</button>
        
 
           <button class="tab-button" data-tab-id="day4">ğŸ—“ï¸ Day 4: 12/8</button>
           <button class="tab-button" data-tab-id="day5">ğŸ—“ï¸ Day 5: 12/9</button>
           <button class="tab-button" data-tab-id="day6">ğŸ—“ï¸ Day 6: 12/10</button>
           <button class="tab-button" data-tab-id="day7">ğŸ—“ï¸ Day 7: 12/11</button>
           <button class="tab-button" data-tab-id="day8">ğŸ—“ï¸ Day 8: 12/12</button>
           <button class="tab-button" data-tab-id="day9">ğŸ—“ï¸ Day 9: 12/13</button>
     
           <button 
                class="tab-button" data-tab-id="day10">ğŸ—“ï¸ Day 10: 12/14</button>
           <button class="tab-button" data-tab-id="day11">ğŸ—“ï¸ Day 11: 12/15</button>
           <button class="tab-button" data-tab-id="day12">ğŸ—“ï¸ Day 12: 12/16</button>
           
           <button class="tab-button" data-tab-id="manager">â• è¡Œç¨‹ç®¡ç†</button>
           
           <button class="tab-button" data-tab-id="stats">ğŸ“Š æ”¯å‡ºçµ±è¨ˆ</button> 
           <button class="tab-button" data-tab-id="packing">ğŸ“¦ æ‰“åŒ…æ¸…å–®</button>
           <button 
                class="tab-button" data-tab-id="documents">ğŸ“„ æ–‡ä»¶æ¸…å–®</button>
           <button class="tab-button" data-tab-id="backup">ğŸ’¾ å„²å­˜ä¿®å¾©</button>
       
       </div>

        <div class="tab-content active" data-tab-content-id="expenses">
           <h2>æ–°å¢/ç®¡ç†æ”¯å‡º ğŸ’¸</h2>
           <div class="input-form">
               <div class="form-group">
                   
                   <label for="expenseDate">æ—¥æœŸ</label>
                   <input type="date" id="expenseDate" value="2025-12-05">
       
                </div>
               <div class="form-group">
                   <label for="expenseCategory">é¡åˆ¥</label>
                  
                   <select id="expenseCategory">
                       <option value="é£²é£Ÿ">é£²é£Ÿ ğŸ•</option>
           
                       <option value="äº¤é€š">äº¤é€š âœˆï¸</option>
                       <option value="ä½å®¿">ä½å®¿ ğŸ¨</option>
            
                       <option value="è³¼ç‰©">è³¼ç‰© ğŸ›ï¸</option>
                       <option value="æ´»å‹•">æ´»å‹• â›·ï¸</option>
           
                       <option value="å…¶ä»–">å…¶ä»– â“</option>
                   </select>
       
               </div>
               <div class="form-group">
                   <label for="expenseDescription">æè¿°</label>
                
                   <input type="text" id="expenseDescription" placeholder="è¼¸å…¥æ¶ˆè²»æè¿°">
               </div>
   
               <div class="form-group" style="width: 120px;
                flex-shrink: 0;">
                    <label for="currentExchangeRate">ç•¶å‰åŒ¯ç‡ (1 NOK = ? NTD)</label>
                    <input type="number" id="currentExchangeRate" placeholder="ä¾‹å¦‚: 3.00" value="3.00" step="0.01" min="0.01">
                </div>
               <div class="form-group" style="width: 100px;
                flex-shrink: 0;">
                   <label for="expenseAmountNOK">æŒªå¨å…‹æœ— (NOK)</label>
                   <input type="number" id="expenseAmountNOK" placeholder="é‡‘é¡" min="1">
               </div>
               <button class="add-button" onclick="addExpense()" style="background-color: #9b7673;">æ–°å¢æ”¯å‡º</button>
           </div>
          
           
           <div class="filter-sort-bar">
               <label for="expenseFilter">ç¯©é¸é¡åˆ¥:</label>
               <select id="expenseFilter" onchange="sortAndFilterExpenses()">
                   <option value="all">æ‰€æœ‰é¡åˆ¥</option>
                   <option value="é£²é£Ÿ">é£²é£Ÿ ğŸ•</option>
             
 
                   <option value="äº¤é€š">äº¤é€š âœˆï¸</option>
                   <option value="ä½å®¿">ä½å®¿ ğŸ¨</option>
                   <option value="è³¼ç‰©">è³¼ç‰© ğŸ›ï¸</option>
                   <option value="æ´»å‹•">æ´»å‹• â›·ï¸</option>
                 
                   <option value="å…¶ä»–">å…¶ä»– â“</option>
               </select>
               <label for="expenseSort">æ’åºæ–¹å¼:</label>
               <select id="expenseSort" onchange="sortAndFilterExpenses()">
                   <option value="date_desc">æ—¥æœŸ (æ–°åˆ°èˆŠ)</option>
                   <option value="date_asc">æ—¥æœŸ (èˆŠåˆ°æ–°)</option>
      
                   <option value="ntd_desc">é‡‘é¡ (é«˜åˆ°ä½)</option>
                   <option value="ntd_asc">é‡‘é¡ (ä½åˆ°é«˜)</option>
                   <option value="category_asc">é¡åˆ¥åç¨±</option>
               </select>
           </div>

           <div class="cost-summary">
      
                <span>ğŸ’° ç¸½è¨ˆè²»ç”¨ (NTD ä¼°ç®—):</span>
               <span class="total-amount-display">NTD <span id="totalAmount">35,810</span></span>
               <span style="font-size: 0.9em;
                color: #4a6984;">(NOK: <span id="totalNokAmount">11,937</span>)</span>
           </div>

           <div id="expenseBody" class="expense-list">
               <div class="expense-card" data-category="ä½å®¿" data-amount="20000" data-nok="6667" data-rate="3.00" data-date-str="12/12" data-iso-date="2025-12-12">
                   <span class="card-icon">ğŸ¨</span>
                   <div class="card-main-info">
           
                        <div class="card-description">CLARION HOTEL THE EDGE å…©æ™š</div>
                       <div class="card-meta">ä½å®¿ Â· 12/12 (åŒ¯ç‡ 3.00)</div>
                   </div>
                   <div class="card-amounts">
                
                        <div class="amount-ntd">NTD 20,000</div>
                       <div class="amount-nok">NOK 6,667</div>
                   </div>
                   <button class="delete-card-btn" onclick="deleteCard(this)">åˆªé™¤</button>
               </div>
           
               <div class="expense-card" data-category="äº¤é€š" data-amount="15000" data-nok="5000" data-rate="3.00" data-date-str="12/05" data-iso-date="2025-12-05">
                   <span class="card-icon">âœˆï¸</span>
                   <div class="card-main-info">
                       <div class="card-description">å°ç£-æŒªå¨ ä¾†å›æ©Ÿç¥¨</div>
                       <div 
                            class="card-meta">äº¤é€š Â· 12/05 (åŒ¯ç‡ 3.00)</div>
                   </div>
                   <div class="card-amounts">
                       <div class="amount-ntd">NTD 15,000</div>
                       <div class="amount-nok">NOK 5,000</div>
       
                    </div>
                   <button class="delete-card-btn" onclick="deleteCard(this)">åˆªé™¤</button>
               </div>
               <div class="expense-card" data-category="é£²é£Ÿ" data-amount="810" data-nok="270" data-rate="3.00" data-date-str="12/05" data-iso-date="2025-12-05">
                   <span class="card-icon">ğŸ•</span>
          
                    <div class="card-main-info">
                       <div class="card-description">æ©Ÿå ´ç°¡é¤</div>
                       <div class="card-meta">é£²é£Ÿ Â· 12/05 (åŒ¯ç‡ 3.00)</div>
                   </div>
                   
                    <div class="card-amounts">
                       <div class="amount-ntd">NTD 810</div>
                       <div class="amount-nok">NOK 270</div>
                   </div>
                   <button class="delete-card-btn" onclick="deleteCard(this)">åˆªé™¤</button>
         
               </div>
           </div>
       </div> 
       <div class="tab-content" data-tab-content-id="day1">
           <div class="activity-card transport-item" data-activity-id="1703271600000" data-type="transport" data-day-id="day1">
                <div class="delete-btn" onclick="deleteActivityCard(this)">åˆªé™¤</div>
                <div class="card-time" contenteditable="true">15:30</div>
                <div class="card-activity-details">
     
                    <div class="editable-content" contenteditable="true">æ­ä¹˜æ©Ÿå ´å·´å£«å‰å¾€é£¯åº—</div>
                    <div class="card-map-links"></div>
                </div>
            </div>
            <div class="activity-card lodging-item" data-activity-id="1703271600001" data-type="lodging" data-day-id="day1">
                <div class="delete-btn" 
                    onclick="deleteActivityCard(this)">åˆªé™¤</div>
                <div class="card-time" contenteditable="true">ä½å®¿</div>
                <div class="card-activity-details">
                    <div class="editable-content" contenteditable="true">Radisson Blu Hotel, TromsÃ¸ (å·²é è¨‚)</div>
                    <div class="card-map-links"></div>
                </div>
  
            </div>
        </div> 
        <div class="tab-content" data-tab-content-id="day2">
            <div class="activity-card" data-activity-id="1703271600002" data-type="activity" data-day-id="day2">
                <div class="delete-btn" onclick="deleteActivityCard(this)">åˆªé™¤</div>
                <div class="card-time" contenteditable="true">09:00</div>
                <div class="card-activity-details">
                    <div class="editable-content" contenteditable="true">åƒè§€ <span class='highlight'>ç‰¹ç¾…å§†ç‘Ÿåšç‰©é¤¨ (TromsÃ¸ Museum)</span></div>
                    <div class="card-map-links"></div>
                </div>
            </div>
            <div class="activity-card" data-activity-id="1703271600003" data-type="activity" data-day-id="day2">
                <div class="delete-btn" onclick="deleteActivityCard(this)">åˆªé™¤</div>
                <div class="card-time" contenteditable="true">13:00</div>
                <div class="card-activity-details">
                    <div class="editable-content" contenteditable="true">åˆé¤ï¼šè©¦è©¦åŒ—æ¥µæµ·é®®æ¹¯</div>
                    <div class="card-map-links"></div>
                </div>
            </div>
            <div class="activity-card" data-activity-id="1703271600004" data-type="activity" data-day-id="day2">
                <div class="delete-btn" onclick="deleteActivityCard(this)">åˆªé™¤</div>
                <div class="card-time" contenteditable="true">19:00</div>
                <div class="card-activity-details">
                    <div class="editable-content" contenteditable="true">åŒ—æ¥µå…‰è¿½é€ä¹‹æ—… (å·²é è¨‚)</div>
                    <div class="card-map-links"></div>
                </div>
            </div>
        </div>
        <div class="tab-content" data-tab-content-id="day3"></div>
        <div class="tab-content" data-tab-content-id="day4"></div>
        <div class="tab-content" data-tab-content-id="day5"></div>
        <div class="tab-content" data-tab-content-id="day6"></div>
        <div class="tab-content" data-tab-content-id="day7"></div>
        <div class="tab-content" data-tab-content-id="day8"></div>
        <div class="tab-content" data-tab-content-id="day9"></div>
        <div class="tab-content" data-tab-content-id="day10"></div>
        <div class="tab-content" data-tab-content-id="day11"></div>
        <div class="tab-content" data-tab-content-id="day12"></div>
        
        <div class="tab-content" data-tab-content-id="manager">
            <div class="itinerary-manager">  
                <h2>è¡Œç¨‹æ–°å¢èˆ‡ç®¡ç†</h2>
                <div class="manager-group">
                    <label>æ–°å¢ç•¶æ—¥æ´»å‹•</label>
                    <div class="input-row">
                        <select id="daySelector">
                        </select>
                        <input type="text" id="newActivityTime" placeholder="æ™‚é–“/æ¨™é¡Œ (å¿…å¡«)" style="flex-grow: 1; min-width: 100px;">
                    </div>
                    <div class="input-row" style="margin-bottom: 10px;">
                        <input type="text" id="newActivityDescription" placeholder="æ´»å‹•æè¿° (å¿…å¡«)">
                        <select id="newActivityType">
                            <option value="activity">ä¸€èˆ¬æ´»å‹•</option>
                            <option value="transport">äº¤é€š ğŸš</option>
                            <option value="lodging">ä½å®¿ ğŸ¨</option>
                        </select>
                    </div>
                    <div class="input-row">
                        <input type="text" id="newActivityMapUrl" placeholder="åœ°åœ– URL (é¸å¡«, è¼¸å…¥å¾Œæœƒè¦†è“‹è‡ªå‹•æœå°‹)">
                        <button class="add-button" onclick="addActivityToDay()" style="flex-shrink: 0;">æ–°å¢æ´»å‹•</button>
                    </div>
                </div>
                <hr style="border-top: 1px solid #c9d2d6; margin: 20px 0;">
                </div>
            </div>
        </div>

        <div class="tab-content" data-tab-content-id="stats">
            <h2>æ”¯å‡ºé¡åˆ¥çµ±è¨ˆ ğŸ“Š</h2>
            <div id="expenseStatsContainer"> 
            </div>
        </div>
        <div class="tab-content" data-tab-content-id="packing">
            <h2>æ‰“åŒ…æ¸…å–® ğŸ“¦</h2>
            <div class="input-form" style="margin-bottom: 20px;">
                <div class="form-group" style="flex-grow: 1;">
                    <label for="packingItem">æ–°å¢ç‰©å“</label>
                    <input type="text" id="packingItem" placeholder="ä¾‹å¦‚: ä¿æš–ç¾½çµ¨å¤–å¥—">
                </div>
                <button class="add-button" onclick="addPackingItem()">æ–°å¢</button>
            </div>
            <div id="packingList" class="expense-list"> 
            </div>
        </div> 
        <div class="tab-content" data-tab-content-id="documents">
            <h2>é‡è¦æ–‡ä»¶æ¸…å–® ğŸ“„</h2>
            <div class="input-form" style="margin-bottom: 20px;">
                <div class="form-group" style="flex-grow: 1;">
                    <label for="docTitle">æ–‡ä»¶æ¨™é¡Œ</label>
                    <input type="text" id="docTitle" placeholder="ä¾‹å¦‚: æ©Ÿç¥¨è¨‚å–®ç·¨è™Ÿ">
                </div>
                <div class="form-group" style="flex-grow: 1;">
                    <label for="docLink">é€£çµ (URL)</label>
                    <input type="text" id="docLink" placeholder="é¸å¡«: è²¼ä¸Šæ–‡ä»¶ç¶²å€">
                </div>
                <button class="add-button" onclick="addDocument()">æ–°å¢æ–‡ä»¶</button>
            </div>
            <div id="documentList" class="document-list"> 
            </div>
        </div> 
        <div class="tab-content" data-tab-content-id="backup">
            <h2>è³‡æ–™å‚™ä»½èˆ‡ä¿®å¾© ğŸ’¾</h2>
            <p>æœ€å¾Œå„²å­˜æ™‚é–“: <span id="lastSaveTime">ç„¡è¨˜éŒ„</span></p>
            <div id="backup-container">
                <button id="export-data-btn" class="add-button" onclick="exportData()">ğŸ’¾ åŒ¯å‡ºå‚™ä»½ (è¤‡è£½åˆ°å‰ªè²¼æ¿)</button>
                <button id="import-data-btn" class="add-button" onclick="importData()">ğŸ”„ åŒ¯å…¥å‚™ä»½ (å°‡è¦†è“‹ç¾æœ‰è³‡æ–™)</button>
            </div>
            <button id="reset-data-btn" class="delete-card-btn" onclick="resetData()">ğŸš¨ é‡ç½®æ‰€æœ‰è³‡æ–™ (å±éšªæ“ä½œ)</button>
        </div>
        
    </div>
</div>

<script>
    // ====================================
    // å…¨å±€è®Šæ•¸
    // ====================================
    const STORAGE_KEY = 'norwayTripPlannerData_v2';
    let EXPENSES = [];
    let ITINERARY = {
        day1: [
            { id: 1703271600000, time: "15:30", description: "æ­ä¹˜æ©Ÿå ´å·´å£«å‰å¾€é£¯åº—", type: "transport", mapUrlOverride: "" },
            { id: 1703271600001, time: "ä½å®¿", description: "Radisson Blu Hotel, TromsÃ¸ (å·²é è¨‚)", type: "lodging", mapUrlOverride: "" }
        ],
        day2: [
            { id: 1703271600002, time: "09:00", description: "åƒè§€ <span class='highlight'>ç‰¹ç¾…å§†ç‘Ÿåšç‰©é¤¨ (TromsÃ¸ Museum)</span>", type: "activity", mapUrlOverride: "" },
            { id: 1703271600003, time: "13:00", description: "åˆé¤ï¼šè©¦è©¦åŒ—æ¥µæµ·é®®æ¹¯", type: "activity", mapUrlOverride: "" },
            { id: 1703271600004, time: "19:00", description: "åŒ—æ¥µå…‰è¿½é€ä¹‹æ—… (å·²é è¨‚)", type: "activity", mapUrlOverride: "" }
        ],
        day3: [], day4: [], day5: [], day6: [], day7: [], day8: [], day9: [], day10: [], day11: [], day12: []
    };
    const DEFAULT_EXPENSES = [
        { date: "2025-12-12", category: "ä½å®¿", description: "CLARION HOTEL THE EDGE å…©æ™š", amountNOK: 6667, amountNTD: 20000, exchangeRate: 3.00 },
        { date: "2025-12-05", category: "äº¤é€š", description: "å°ç£-æŒªå¨ ä¾†å›æ©Ÿç¥¨", amountNOK: 5000, amountNTD: 15000, exchangeRate: 3.00 },
        { date: "2025-12-05", category: "é£²é£Ÿ", description: "æ©Ÿå ´ç°¡é¤", amountNOK: 270, amountNTD: 810, exchangeRate: 3.00 }
    ];
    let PACKING_LIST = [];
    let DOCUMENTS = [];
    
    // é è¨­é ç±¤åˆ—è¡¨
    const DEFAULT_TABS = [
        { id: "day1", title: "ğŸ—“ï¸ Day 1: 12/5" },
        { id: "day2", title: "ğŸ—“ï¸ Day 2: 12/6" },
        { id: "day3", title: "ğŸ—“ï¸ Day 3: 12/7" },
        { id: "day4", title: "ğŸ—“ï¸ Day 4: 12/8" },
        { id: "day5", title: "ğŸ—“ï¸ Day 5: 12/9" },
        { id: "day6", title: "ğŸ—“ï¸ Day 6: 12/10" },
        { id: "day7", title: "ğŸ—“ï¸ Day 7: 12/11" },
        { id: "day8", title: "ğŸ—“ï¸ Day 8: 12/12" },
        { id: "day9", title: "ğŸ—“ï¸ Day 9: 12/13" },
        { id: "day10", title: "ğŸ—“ï¸ Day 10: 12/14" },
        { id: "day11", title: "ğŸ—“ï¸ Day 11: 12/15" },
        { id: "day12", title: "ğŸ—“ï¸ Day 12: 12/16" }
    ];
    let ITINERARY_TABS = DEFAULT_TABS;
    let dayCounter = 12;

    document.addEventListener('DOMContentLoaded', function() {
        loadData();

        // åˆå§‹åŒ– Tab é»æ“Šäº‹ä»¶
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', function() {
                switchTab(this.getAttribute('data-tab-id'));
            });
        });

        // è¨­ç½®é è¨­ Tab
        const defaultTab = document.querySelector('.tab-button[data-tab-id="expenses"]');
        if (defaultTab) {
            switchTab("expenses");
        } else {
            const firstTab = document.querySelector('.tab-button');
            if (firstTab) {
                switchTab(firstTab.getAttribute('data-tab-id'));
            }
        }
    });

    // ====================================
    // DOM æ“ä½œèˆ‡è¼”åŠ©å‡½æ•¸
    // ====================================

    // å•Ÿå‹•æ‰€æœ‰ contenteditable æ¬„ä½çš„äº‹ä»¶ç›£è½å™¨
    function initEditableContent() {
        document.querySelectorAll('.editable-content, .card-time[contenteditable="true"]').forEach(element => {
            // ç¢ºä¿ onblur äº‹ä»¶å·²ç¶å®šï¼Œä»¥è‡ªå‹•å„²å­˜
            element.removeEventListener('blur', saveData);
            element.addEventListener('blur', saveData);

            // è™•ç†è²¼ä¸Šäº‹ä»¶ï¼Œé¿å…è²¼ä¸Š HTML æ¨£å¼
            element.removeEventListener('paste', handleEditablePaste);
            element.addEventListener('paste', handleEditablePaste);

            // é‡å°æ´»å‹•å…§å®¹ï¼Œæ–°å¢ä¸€å€‹ input ç›£è½å™¨ï¼Œä»¥ä¾¿å…§å®¹æ”¹è®Šæ™‚æ›´æ–°åœ°åœ–é€£çµ
            if (element.classList.contains('editable-content')) {
                element.removeEventListener('input', updateMapLinksOnInput);
                element.addEventListener('input', updateMapLinksOnInput);
            }
        });
    }

    function handleEditablePaste(event) {
        event.preventDefault();
        const text = event.clipboardData.getData('text/plain');
        document.execCommand('insertText', false, text);
        // è§¸ç™¼ input äº‹ä»¶ä¾†æ›´æ–°åœ°åœ–é€£çµ
        if (event.target.classList.contains('editable-content')) {
            updateMapLinksOnInput({ target: event.target });
        }
    }

    function updateMapLinksOnInput(event) {
        const card = event.target.closest('.activity-card');
        if (card) {
            // å»¶é²æ›´æ–°ï¼Œé¿å…è¼¸å…¥æ™‚é »ç¹è§¸ç™¼
            clearTimeout(card.updateTimer);
            card.updateTimer = setTimeout(() => {
                updateMapLinksForCard(card);
            }, 500);
        }
    }

    function getGoogleMapsUrl(query) {
        if (!query) return null;
        const encodedQuery = encodeURIComponent(query);
        // ä½¿ç”¨ Google Maps çš„æœå°‹ URL
        return `https://www.google.com/maps/search/?api=1&query=${encodedQuery}`;
    }

    function updateAllMapLinks() {
        document.querySelectorAll('.activity-card').forEach(updateMapLinksForCard);
    }

    function editMapLink(btn) {
        const card = btn.closest('.activity-card');
        const dayId = card.closest('.tab-content').getAttribute('data-tab-content-id');
        const activityId = parseInt(card.getAttribute('data-activity-id'));
        const activity = ITINERARY[dayId] ? ITINERARY[dayId].find(a => a.id === activityId) : null;

        if (!activity) return;

        const currentUrl = activity.mapUrlOverride || '';
        const newUrl = prompt(`è«‹è¼¸å…¥åœ°åœ–çš„å®Œæ•´ URL (è²¼ä¸Š Google Maps åˆ†äº«é€£çµç­‰)ï¼Œæˆ–è¼¸å…¥ã€Œæ¸…é™¤ã€ä»¥ä½¿ç”¨è‡ªå‹•æœå°‹:\n\nç•¶å‰é€£çµ: ${currentUrl}`, currentUrl);

        if (newUrl === null) {
            return; // ä½¿ç”¨è€…æŒ‰å–æ¶ˆ
        }

        const trimmedUrl = newUrl.trim();
        if (trimmedUrl.toLowerCase() === 'æ¸…é™¤' || trimmedUrl === '') {
            activity.mapUrlOverride = ""; // æ¸…é™¤å„²å­˜çš„é€£çµ
            alert('å·²ç§»é™¤æ‰‹å‹•é€£çµï¼Œå°‡ä½¿ç”¨è‡ªå‹•æœå°‹ã€‚');
        } else if (trimmedUrl.startsWith('http')) {
            // å¦‚æœè¼¸å…¥äº†æœ‰æ•ˆçš„ URL
            activity.mapUrlOverride = trimmedUrl; // å„²å­˜æ–°çš„é€£çµ
            alert('æ‰‹å‹•é€£çµå·²è¨­å®šæˆåŠŸã€‚');
        } else {
            alert('è¼¸å…¥ç„¡æ•ˆã€‚è«‹è¼¸å…¥ä»¥ http:// æˆ– https:// é–‹é ­çš„å®Œæ•´ URLï¼Œæˆ–è¼¸å…¥ã€Œæ¸…é™¤ã€ã€‚');
            return;
        }

        saveData(); // å„²å­˜æ•¸æ“š
        updateMapLinksForCard(card); // æ›´æ–°å¡ç‰‡é¡¯ç¤º
    }

    /**
     * æ›´æ–°å–®å€‹æ´»å‹•å¡ç‰‡çš„å‹•æ…‹åœ°åœ–é€£çµé¡¯ç¤ºã€‚
     */
    function updateMapLinksForCard(card) {
        const dayId = card.closest('.tab-content').getAttribute('data-tab-content-id');
        const activityId = parseInt(card.getAttribute('data-activity-id'));
        // ç¢ºä¿ card æœ‰ data-day-id å±¬æ€§ (é€™æ˜¯æ–°å¢çš„ä¿®æ”¹ï¼Œç¢ºä¿ JS èƒ½æ­£ç¢ºæ‰¾åˆ°)
        card.setAttribute('data-day-id', dayId);

        const activity = ITINERARY[dayId] ? ITINERARY[dayId].find(a => a.id === activityId) : null;
        const editableContent = card.querySelector('.editable-content');
        const mapLinksContainer = card.querySelector('.card-map-links');

        if (!activity || !editableContent || !mapLinksContainer) {
            if(mapLinksContainer) mapLinksContainer.innerHTML = '';
            return;
        }

        let linkHtml = '';
        const savedUrl = activity.mapUrlOverride; // å¾æ•¸æ“šä¸­ç²å–æ‰‹å‹•é€£çµ
        const activityText = editableContent.innerText.trim();

        // 1. åˆ¤æ–·ä½¿ç”¨æ‰‹å‹•é€£çµé‚„æ˜¯è‡ªå‹•ç”Ÿæˆé€£çµ
        if (savedUrl && savedUrl.startsWith('http')) {
            // ä½¿ç”¨æ‰‹å‹•é€£çµ
            linkHtml = `<a href="${savedUrl}" target="_blank" class="map-link" title="æ‰‹å‹•è¨­å®šé€£çµ">ğŸ”— æ‰‹å‹•é€£çµ</a>`;
        } else if (activityText && activity.type === 'activity') {
            // åªå°ä¸€èˆ¬æ´»å‹•å•Ÿç”¨è‡ªå‹•æœå°‹
            // è‡ªå‹•ç”Ÿæˆé€£çµ (ä½¿ç”¨å‰ 50 å­—ä½œç‚ºæŸ¥è©¢)
            const searchQuery = activityText.substring(0, 50);
            const mapUrl = getGoogleMapsUrl(searchQuery);
            if (mapUrl) {
                linkHtml = `<a href="${mapUrl}" target="_blank" class="map-link" title="Google Maps æœå°‹: ${searchQuery}">ğŸ—ºï¸ è‡ªå‹•æœå°‹</a>`;
            }
        }

        // 2. åŠ å…¥ç·¨è¼¯æŒ‰éˆ•
        const editButtonHtml = `<a href="javascript:void(0)" onclick="editMapLink(this)" class="map-link edit-link" title="è¨­å®šæˆ–æ¸…é™¤åœ°åœ–é€£çµ">ğŸ“ ç·¨è¼¯é€£çµ</a>`;
        mapLinksContainer.innerHTML = linkHtml + editButtonHtml;
    }


    // åˆ‡æ›é ç±¤
    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('active');
        });

        document.querySelector(`.tab-content[data-tab-content-id="${tabId}"]`).classList.add('active');
        document.querySelector(`.tab-button[data-tab-id="${tabId}"]`).classList.add('active');
        
        // å¦‚æœåˆ‡æ›åˆ° Day æˆ– Manager Tabï¼Œæ›´æ–° Day Selector çš„é¸é …
        if (tabId.startsWith('day') || tabId === 'manager') {
            loadDaySelector();
            const daySelector = document.getElementById('daySelector');
            if (daySelector && tabId.startsWith('day')) {
                 daySelector.value = tabId;
            } else if (daySelector && !daySelector.value) {
                 // å¦‚æœåœ¨ manager é é¢ï¼Œé è¨­é¸æ“‡ day1
                 daySelector.value = 'day1';
            }
        }
        
        // å¦‚æœæ˜¯ stats é é¢ï¼Œé‡æ–°ç”Ÿæˆçµ±è¨ˆè¡¨
        if (tabId === 'stats') {
            generateExpenseStatsTable();
        }
    }
    
    // æ¸²æŸ“å–®å€‹æ´»å‹•å¡ç‰‡
    function renderActivityCard(activity, dayId) {
        const typeClass = activity.type === 'transport' ? 'transport-item' : 
                          activity.type === 'lodging' ? 'lodging-item' : '';
        const html = `
            <div class="activity-card ${typeClass}" data-activity-id="${activity.id}" data-type="${activity.type}" data-day-id="${dayId}">
                <div class="delete-btn" onclick="deleteActivityCard(this)">åˆªé™¤</div>
                <div class="card-time" contenteditable="true">${activity.time || ''}</div>
                <div class="card-activity-details">
                    <div class="editable-content" contenteditable="true">${activity.description || ''}</div>
                    <div class="card-map-links"></div>
                </div>
            </div>
        `;
        return html;
    }

    // åˆªé™¤è¡Œç¨‹æ´»å‹•
    function deleteActivityCard(btn) {
        if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¡Œç¨‹æ´»å‹•å—ï¼Ÿ')) return;
        const card = btn.closest('.activity-card');
        const dayId = card.getAttribute('data-day-id');
        const activityId = parseInt(card.getAttribute('data-activity-id'));

        // å¾ ITINERARY æ•¸æ“šçµæ§‹ä¸­åˆªé™¤
        if (ITINERARY[dayId]) {
            ITINERARY[dayId] = ITINERARY[dayId].filter(a => a.id !== activityId);
        }
        card.remove(); // å¾ DOM ä¸­åˆªé™¤å¡ç‰‡
        saveData();
    }

    // è¼‰å…¥ Day Selector é¸é …
    function loadDaySelector() {
        const selector = document.getElementById('daySelector');
        if (!selector) return;

        selector.innerHTML = ''; // æ¸…ç©ºç¾æœ‰é¸é …

        // é‡æ–°å¾ ITINERARY_TABS å‰µå»ºé¸é …
        ITINERARY_TABS.forEach(tab => {
            if (tab.id.startsWith('day')) {
                const option = document.createElement('option');
                option.value = tab.id;
                option.textContent = tab.title;
                selector.appendChild(option);
            }
        });

        // é è¨­é¸å–ç•¶å‰é ç±¤ (å¦‚æœå®ƒæ˜¯ Day é ç±¤)
        const activeTabId = document.querySelector('.tab-button.active')?.getAttribute('data-tab-id');
        if (activeTabId && activeTabId.startsWith('day')) {
            selector.value = activeTabId;
        } else if (selector.options.length > 0) {
            // å¦‚æœç•¶å‰ä¸åœ¨ Day é ç±¤ï¼Œé è¨­é¸æ“‡ Day 1
            selector.value = selector.options[0].value;
        }
    }

    // æ–°å¢è¡Œç¨‹æ´»å‹•åˆ°ç•¶æ—¥
    function addActivityToDay() {
        const dayId = document.getElementById('daySelector').value;
        const time = document.getElementById('newActivityTime').value.trim();
        const description = document.getElementById('newActivityDescription').value.trim();
        const type = document.getElementById('newActivityType').value;
        const mapUrlOverride = document.getElementById('newActivityMapUrl').value.trim();

        if (dayId === '' || time === '' || description === '') {
            alert('è«‹å¡«å¯«å®Œæ•´ã€Œæ—¥æœŸã€ã€ã€Œæ™‚é–“/æ¨™é¡Œã€å’Œã€Œæ´»å‹•æè¿°ã€ï¼');
            return;
        }

        const newActivity = {
            id: Date.now(),
            time: time,
            description: description,
            type: type,
            mapUrlOverride: mapUrlOverride.startsWith('http') ? mapUrlOverride : ""
        };

        // ç¢ºä¿ Day ID åœ¨ ITINERARY ä¸­å­˜åœ¨
        if (!ITINERARY[dayId]) {
             ITINERARY[dayId] = [];
        }

        ITINERARY[dayId].push(newActivity);

        // æ¸²æŸ“åˆ° DOM
        const tabContent = document.querySelector(`.tab-content[data-tab-content-id="${dayId}"]`);
        if (tabContent) {
            tabContent.insertAdjacentHTML('beforeend', renderActivityCard(newActivity, dayId));
            
            // æ‰¾åˆ°æ–°å¡ç‰‡ä¸¦åˆå§‹åŒ–ç·¨è¼¯äº‹ä»¶å’Œåœ°åœ–é€£çµ
            const newCard = tabContent.lastElementChild;
            initEditableContent();
            updateMapLinksForCard(newCard);
        }

        // æ¸…ç©ºè¼¸å…¥æ¡†
        document.getElementById('newActivityTime').value = '';
        document.getElementById('newActivityDescription').value = '';
        document.getElementById('newActivityMapUrl').value = '';

        saveData();
    }

    // æ–°å¢ä¸€å¤©è¡Œç¨‹
    function addDayTab() {
        const titleInput = document.getElementById('newDayTitle');
        const newTitle = titleInput.value.trim();

        if (newTitle === '') {
            alert('è«‹è¼¸å…¥æ–°çš„ Day æ¨™é¡Œï¼');
            return;
        }

        dayCounter++;
        const newDayId = `day${dayCounter}`;
        const defaultDayTitle = `ğŸ—“ï¸ Day ${dayCounter}`;
        const finalTitle = newTitle.startsWith('ğŸ—“ï¸ Day') ? newTitle : defaultDayTitle + (newTitle ? `: ${newTitle}` : '');


        // 1. æ–°å¢ Tab Button
        const tabBar = document.getElementById('tabBar');
        const newButton = document.createElement('button');
        newButton.classList.add('tab-button');
        newButton.setAttribute('data-tab-id', newDayId);
        newButton.textContent = finalTitle;
        newButton.addEventListener('click', function() { switchTab(this.getAttribute('data-tab-id')); });

        // å°‹æ‰¾æ’å…¥ä½ç½®ï¼šåœ¨ Day é ç±¤çš„æœ€å¾Œä¸€å€‹ (day12) å¾Œé¢ï¼Œä½†åœ¨ manager é ç±¤å‰é¢
        let lastDayButton = document.querySelector('.tab-button[data-tab-id="day12"]');
        let insertBeforeElement = document.querySelector('.tab-button[data-tab-id="manager"]');
        
        // ç¢ºä¿æ’å…¥ä½ç½®æ­£ç¢º
        if (insertBeforeElement) {
            tabBar.insertBefore(newButton, insertBeforeElement);
        } else if (lastDayButton) {
            tabBar.insertBefore(newButton, lastDayButton.nextElementSibling);
        } else {
             // å¦‚æœé€£ day12 éƒ½æ²’æœ‰ï¼Œå‰‡å¯èƒ½æ”¾åœ¨ expenses å¾Œé¢
             tabBar.appendChild(newButton);
        }


        // 2. æ–°å¢ Tab Content
        const itinerarySection = document.getElementById('itinerarySection');
        const newContent = document.createElement('div');
        newContent.classList.add('tab-content');
        newContent.setAttribute('data-tab-content-id', newDayId);
        
        // å°‹æ‰¾æ’å…¥ä½ç½®ï¼šåœ¨ Day é ç±¤çš„æœ€å¾Œä¸€å€‹ (day12) å…§å®¹å¾Œé¢ï¼Œä½†åœ¨ manager å…§å®¹å‰é¢
        let lastDayContent = document.querySelector('.tab-content[data-tab-content-id="day12"]');
        let contentInsertBeforeElement = document.querySelector('.tab-content[data-tab-content-id="manager"]');

        if (contentInsertBeforeElement) {
            itinerarySection.insertBefore(newContent, contentInsertBeforeElement);
        } else if (lastDayContent) {
            itinerarySection.insertBefore(newContent, lastDayContent.nextElementSibling);
        } else {
            itinerarySection.appendChild(newContent);
        }


        // 3. æ›´æ–°æ•¸æ“šçµæ§‹
        ITINERARY_TABS.push({ id: newDayId, title: finalTitle });
        ITINERARY[newDayId] = [];

        // 4. æ›´æ–°é¸æ“‡å™¨å’Œå„²å­˜
        loadDaySelector();
        saveData();

        // 5. åˆ‡æ›åˆ°æ–°çš„ä¸€å¤©
        switchTab(newDayId);
        titleInput.value = '';
    }

    // ====================================
    // è²»ç”¨æ¸…å–®åŠŸèƒ½
    // ====================================
    
    // æ ¹æ“šé¡åˆ¥ç²å– Emoji
    function getCategoryEmoji(category) {
        switch (category) {
            case 'é£²é£Ÿ': return 'ğŸ•';
            case 'äº¤é€š': return 'âœˆï¸';
            case 'ä½å®¿': return 'ğŸ¨';
            case 'è³¼ç‰©': return 'ğŸ›ï¸';
            case 'æ´»å‹•': return 'â›·ï¸';
            case 'å…¶ä»–': return 'â“';
            default: return 'â“';
        }
    }

    // ç²å–ç•¶å‰åŒ¯ç‡
    function getCurrentExchangeRate() {
        const rate = parseFloat(document.getElementById('currentExchangeRate').value);
        return isNaN(rate) ||
            rate <= 0 ? 3.00 : rate;
    }

    // æ–°å¢æ”¯å‡º
    function addExpense() {
        const date = document.getElementById('expenseDate').value;
        const category = document.getElementById('expenseCategory').value;
        const description = document.getElementById('expenseDescription').value.trim();
        const amountNOK = parseFloat(document.getElementById('expenseAmountNOK').value);
        const rate = getCurrentExchangeRate();

        if (!date || !description || isNaN(amountNOK) || amountNOK <= 0) {
            alert('è«‹å¡«å¯«å®Œæ•´æ—¥æœŸã€æè¿°å’ŒæŒªå¨å…‹æœ—é‡‘é¡ï¼');
            return;
        }

        const amountNTD = Math.round(amountNOK * rate);

        const newExpense = {
            date: date,
            category: category,
            description: description,
            amountNOK: amountNOK,
            amountNTD: amountNTD,
            exchangeRate: rate
        };

        EXPENSES.push(newExpense); // æ¨å…¥åˆ°æ•¸æ“šçµæ§‹

        // æ¸²æŸ“åˆ° DOM (ä½¿ç”¨ sortAndFilterExpenses çµ±ä¸€æ¸²æŸ“)
        sortAndFilterExpenses(); 

        // æ¸…ç©ºè¼¸å…¥æ¡†
        document.getElementById('expenseDescription').value = '';
        document.getElementById('expenseAmountNOK').value = '';

        saveData();
    }

    // åˆªé™¤è²»ç”¨å¡ç‰‡
    function deleteCard(btn) {
        if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è³‡æ–™å—ï¼Ÿ')) return;
        
        const card = btn.closest('.expense-card') || btn.closest('.document-card') || btn.closest('.packing-item');
        if (!card) return;

        // åˆ¤æ–·æ˜¯è²»ç”¨ã€æ–‡ä»¶é‚„æ˜¯æ‰“åŒ…æ¸…å–®
        if (card.classList.contains('expense-card')) {
            const date = card.getAttribute('data-iso-date');
            const description = card.querySelector('.card-description').textContent.trim();
            
            // å¾ EXPENSES æ•¸æ“šçµæ§‹ä¸­åˆªé™¤
            const index = EXPENSES.findIndex(e => e.date === date && e.description === description);
            if (index !== -1) {
                EXPENSES.splice(index, 1);
            }
            sortAndFilterExpenses(); // é‡æ–°æ¸²æŸ“è²»ç”¨æ¸…å–®
        } else if (card.classList.contains('document-card')) {
            const title = card.getAttribute('data-doc-title');
            const index = DOCUMENTS.findIndex(d => d.title === title);
            if (index !== -1) {
                DOCUMENTS.splice(index, 1);
            }
            card.remove();
        } else if (card.classList.contains('packing-item')) {
            const desc = card.getAttribute('data-item-desc');
            const index = PACKING_LIST.findIndex(p => p.description === desc);
            if (index !== -1) {
                PACKING_LIST.splice(index, 1);
            }
            card.remove();
        }

        saveData();
    }

    // æ›´æ–°ç¸½è¨ˆ
    function updateTotal() {
        const visibleExpenses = Array.from(document.getElementById('expenseBody').querySelectorAll('.expense-card'))
            .filter(card => card.style.display !== 'none');
        
        let totalNTD = 0;
        let totalNOK = 0;

        visibleExpenses.forEach(card => {
            totalNTD += parseInt(card.getAttribute('data-amount'));
            totalNOK += parseFloat(card.getAttribute('data-nok'));
        });

        document.getElementById('totalAmount').textContent = totalNTD.toLocaleString('en-US');
        document.getElementById('totalNokAmount').textContent = totalNOK.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }

    // æ’åºå’Œç¯©é¸è²»ç”¨æ¸…å–®
    function sortAndFilterExpenses() {
        const filterCriteria = document.getElementById('expenseFilter').value;
        const sortCriteria = document.getElementById('expenseSort').value;
        const container = document.getElementById('expenseBody');
        
        // 1. æ¸…ç©ºä¸¦é‡æ–°æ¸²æŸ“æ‰€æœ‰ EXPENSES
        container.innerHTML = EXPENSES.map(expense => {
            const rate = expense.exchangeRate || getCurrentExchangeRate();
            const amountNTD = expense.amountNTD || Math.round(expense.amountNOK * rate);
            const dateObj = new Date(expense.date);
            const dateStr = `${dateObj.getMonth() + 1}/${dateObj.getDate()}`;
            const emoji = getCategoryEmoji(expense.category);
            
            return `
                <div class="expense-card" data-category="${expense.category}" data-amount="${amountNTD}" data-nok="${expense.amountNOK}" data-rate="${rate.toFixed(2)}" data-date-str="${dateStr}" data-iso-date="${expense.date}">
                    <span class="card-icon">${emoji}</span>
                    <div class="card-main-info">
                        <div class="card-description">${expense.description}</div>
                        <div class="card-meta">${expense.category} Â· ${dateStr} (åŒ¯ç‡ ${rate.toFixed(2)})</div>
                    </div>
                    <div class="card-amounts">
                        <div class="amount-ntd">NTD ${amountNTD.toLocaleString('en-US')}</div>
                        <div class="amount-nok">NOK ${expense.amountNOK.toLocaleString('en-US')}</div>
                    </div>
                    <button class="delete-card-btn" onclick="deleteCard(this)">åˆªé™¤</button>
                </div>
            `;
        }).join('');

        let cards = Array.from(container.querySelectorAll('.expense-card'));
        
        // 2. ç¯©é¸
        cards.forEach(card => {
            const category = card.getAttribute('data-category');
            card.style.display = (filterCriteria === 'all' || category === filterCriteria) ? 'flex' : 'none';
        });

        let visibleCards = cards.filter(card => card.style.display !== 'none');

        // 3. æ’åº
        visibleCards.sort((a, b) => {
            const amountA = parseInt(a.getAttribute('data-amount'));
            const amountB = parseInt(b.getAttribute('data-amount'));
            const dateA = a.getAttribute('data-iso-date');
            const dateB = b.getAttribute('data-iso-date');
            const categoryA = a.getAttribute('data-category');
            const categoryB = b.getAttribute('data-category');

            switch (sortCriteria) {
                case 'date_desc': return dateB.localeCompare(dateA);
                case 'date_asc': return dateA.localeCompare(dateB);
                case 'ntd_desc': return amountB - amountA;
                case 'ntd_asc': return amountA - amountB;
                case 'category_asc': return categoryA.localeCompare(categoryB);
                default: return 0;
            }
        });

        // 4. é‡æ–°æ’å…¥ DOM (ä¿ç•™éå¯è¦‹çš„å¡ç‰‡åœ¨åŸä½)
        container.innerHTML = '';
        visibleCards.forEach(card => container.appendChild(card));

        updateTotal(); // æ›´æ–°ç¸½è¨ˆ (åªè¨ˆç®—å¯è¦‹çš„)
    }

    // ===================================
    // æ”¯å‡ºçµ±è¨ˆåŠŸèƒ½
    // ===================================

    function generateExpenseStatsTable() {
        const container = document.getElementById('expenseStatsContainer');
        if (!container) return;

        const categoryTotals = {};
        let grandTotalNTD = 0;

        // è¨ˆç®—æ¯å€‹é¡åˆ¥çš„ç¸½é¡
        EXPENSES.forEach(expense => {
            const category = expense.category;
            const amount = expense.amountNTD;
            categoryTotals[category] = (categoryTotals[category] || 0) + amount;
            grandTotalNTD += amount;
        });

        if (grandTotalNTD === 0) {
            container.innerHTML = '<p style="color: #9b7673; font-weight: bold;">ç›®å‰æ²’æœ‰ä»»ä½•æ”¯å‡ºè¨˜éŒ„ã€‚</p>';
            return;
        }

        let tableHtml = `
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>é¡åˆ¥</th>
                        <th style="text-align: right;">é‡‘é¡ (NTD)</th>
                        <th>ä½”ç¸½é¡ç™¾åˆ†æ¯”</th>
                    </tr>
                </thead>
                <tbody>
        `;

        // æ’åºé¡åˆ¥åç¨±
        const sortedCategories = Object.keys(categoryTotals).sort();

        // å¡«å……è¡¨æ ¼å…§å®¹
        sortedCategories.forEach(category => {
            const total = categoryTotals[category];
            const percentage = ((total / grandTotalNTD) * 100).toFixed(1);

            tableHtml += `
                <tr>
                    <td>${getCategoryEmoji(category)} ${category}</td>
                    <td style="text-align: right;">${total.toLocaleString('en-US')}</td>
                    <td class="percentage-cell">${percentage}%</td>
                </tr>
            `;
        });

        tableHtml += `
            <tr class="total-row">
                <td>ç¸½è¨ˆ</td>
                <td style="text-align: right;">${grandTotalNTD.toLocaleString('en-US')}</td>
                <td class="percentage-cell">100.0%</td>
            </tr>
            </tbody>
            </table>
        `;

        container.innerHTML = tableHtml;
    }

    // ===================================
    // æ‰“åŒ…æ¸…å–®åŠŸèƒ½
    // ===================================

    function addPackingItem() {
        const item = document.getElementById('packingItem').value.trim();
        if (item === '') {
            alert('è«‹è¼¸å…¥ç‰©å“åç¨±ï¼');
            return;
        }

        const newItem = { description: item, checked: false };
        PACKING_LIST.push(newItem);

        // æ¸²æŸ“åˆ° DOM
        renderPackingList();

        document.getElementById('packingItem').value = '';
        saveData();
    }

    function togglePackingCheck(card) {
        const desc = card.getAttribute('data-item-desc');
        const item = PACKING_LIST.find(p => p.description === desc);
        
        if (item) {
            item.checked = !item.checked;
            // æ ¹æ“šæ•¸æ“šç‹€æ…‹æ›´æ–° DOM æ¨£å¼
            card.classList.toggle('checked', item.checked);
        }
        saveData();
    }

    function renderPackingList() {
        const container = document.getElementById('packingList');
        container.innerHTML = PACKING_LIST.map(item => {
            const checkedClass = item.checked ? 'checked' : '';
            return `
                <div class="packing-item ${checkedClass}" data-item-desc="${item.description}" onclick="togglePackingCheck(this)">
                    <div class="card-main-info">
                        <div class="card-description">${item.description}</div>
                    </div>
                    <button class="delete-card-btn" onclick="event.stopPropagation(); deleteCard(this);">åˆªé™¤</button>
                </div>
            `;
        }).join('');
    }
    
    // ===================================
    // é‡è¦æ–‡ä»¶åŠŸèƒ½
    // ===================================

    function addDocument() {
        const title = document.getElementById('docTitle').value.trim();
        const link = document.getElementById('docLink').value.trim();

        if (title === '') {
            alert('è«‹è¼¸å…¥æ–‡ä»¶æ¨™é¡Œï¼');
            return;
        }

        if (link !== '' && !link.startsWith('http')) {
            alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„ URL é€£çµ (éœ€åŒ…å« http:// æˆ– https://)ã€‚');
            return;
        }

        const newDocData = { title: title, link: link };
        DOCUMENTS.push(newDocData); // å„²å­˜åˆ°æ•¸æ“šçµæ§‹

        // æ¸²æŸ“åˆ° DOM
        renderDocumentList();

        document.getElementById('docTitle').value = '';
        document.getElementById('docLink').value = '';
        saveData();
    }

    function renderDocumentList() {
        const documentList = document.getElementById('documentList');
        documentList.innerHTML = DOCUMENTS.map(doc => {
            const linkHTML = doc.link && doc.link.startsWith('http') ?
                `<a href="${doc.link}" target="_blank" class="doc-link">ğŸ”— æŸ¥çœ‹æ–‡ä»¶</a>` :
                `<span class="doc-link" style="color:#999; cursor:default;">ç„¡é€£çµ</span>`;
            
            return `
                <div class="document-card" data-doc-title="${doc.title || 'ç„¡æ¨™é¡Œ'}" data-doc-link="${doc.link || ''}">
                    <div class="document-title">${doc.title || 'ç„¡æ¨™é¡Œ'}</div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        ${linkHTML}
                        <button class="delete-card-btn" onclick="deleteCard(this)">åˆªé™¤</button>
                    </div>
                </div>
            `;
        }).join('');
    }

    // ====================================
    // è³‡æ–™å„²å­˜èˆ‡è¼‰å…¥
    // ====================================

    // ç²å–è¡Œç¨‹æ¸…å–®çš„çµæ§‹åŒ–è³‡æ–™ (å¾ DOM ä¸­æ›´æ–° ITINERARY æ•¸æ“š)
    function getItineraryData() {
        // ç¢ºä¿ ITINERARY çµæ§‹èˆ‡ç•¶å‰ DOM ç‹€æ…‹åŒæ­¥
        ITINERARY_TABS.forEach(tab => {
            const dayId = tab.id;
            const activities = [];
            const cards = document.querySelectorAll(`.tab-content[data-tab-content-id="${dayId}"] .activity-card`);

            cards.forEach(card => {
                const activityId = parseInt(card.getAttribute('data-activity-id'));
                const activityTime = card.querySelector('.card-time').textContent.trim();
                const activityDescription = card.querySelector('.editable-content').innerHTML.trim(); // ä½¿ç”¨ innerHTML ç²å–é«˜äº®æ¨™ç±¤
                const activityType = card.getAttribute('data-type');
                
                // å˜—è©¦å¾ ITINERARY æ‰¾åˆ°å·²å„²å­˜çš„ mapUrlOverride
                const existingActivity = ITINERARY[dayId] ? ITINERARY[dayId].find(a => a.id === activityId) : null;
                const mapUrlOverride = existingActivity ? existingActivity.mapUrlOverride : "";

                activities.push({
                    id: activityId,
                    time: activityTime,
                    description: activityDescription,
                    type: activityType,
                    mapUrlOverride: mapUrlOverride // å„²å­˜ override é€£çµï¼Œè€Œä¸æ˜¯å¾ DOM è®€å–
                });
            });
            ITINERARY[dayId] = activities;
        });
        return ITINERARY;
    }

    // å„²å­˜æ‰€æœ‰æ•¸æ“š
    function saveData() {
        getItineraryData(); // å¾ DOM æ›´æ–°è¡Œç¨‹æ•¸æ“š
        
        const data = {
            expenses: EXPENSES,
            itinerary: ITINERARY,
            itineraryTabs: ITINERARY_TABS,
            dayCounter: dayCounter,
            packingList: PACKING_LIST,
            documents: DOCUMENTS,
            exchangeRate: getCurrentExchangeRate(),
            saveTime: new Date().toLocaleString()
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        document.getElementById('lastSaveTime').textContent = data.saveTime;
    }

    // è¼‰å…¥æ‰€æœ‰æ•¸æ“š
    function loadData() {
        const dataString = localStorage.getItem(STORAGE_KEY);
        const rateInput = document.getElementById('currentExchangeRate');

        if (!dataString) {
            // åˆå§‹åŒ–é è¨­å€¼
            EXPENSES = DEFAULT_EXPENSES;
            // ITINERARY å·²ç¶“æœ‰é è¨­å€¼
            ITINERARY_TABS = DEFAULT_TABS;
            
            // æ¸²æŸ“é è¨­å…§å®¹
            renderItinerary();
            renderPackingList();
            renderDocumentList();
            sortAndFilterExpenses(); // è¼‰å…¥å¾Œå…ˆåŸ·è¡Œä¸€æ¬¡ç¯©é¸æ’åºå’Œç¸½è¨ˆ
            loadDaySelector();
            initEditableContent(); // åˆå§‹åŒ–é è¨­å…§å®¹çš„ç·¨è¼¯äº‹ä»¶
            updateAllMapLinks(); // åˆå§‹åŒ–é è¨­å…§å®¹çš„åœ°åœ–é€£çµé¡¯ç¤º
            return;
        }

        try {
            const data = JSON.parse(dataString);

            // é©—è­‰æ ¸å¿ƒæ•¸æ“šçµæ§‹
            if (!data.expenses || !data.itinerary || !data.itineraryTabs || !data.dayCounter) {
                throw new Error("è³‡æ–™çµæ§‹ä¸å®Œæ•´ï¼Œå°‡é‡ç½®ç‚ºé è¨­å€¼ã€‚");
            }

            // 1. è¼‰å…¥è²»ç”¨æ¸…å–®
            EXPENSES = data.expenses || DEFAULT_EXPENSES;
            // è²»ç”¨æ¸…å–®å°‡åœ¨ sortAndFilterExpenses() ä¸­è¢«æ¸²æŸ“

            // 2. è¼‰å…¥è¡Œç¨‹é ç±¤èˆ‡å…§å®¹
            ITINERARY = data.itinerary || ITINERARY;
            ITINERARY_TABS = data.itineraryTabs || DEFAULT_TABS;
            dayCounter = data.dayCounter || 12;
            
            // æ¸…ç©º Tab Button
            const tabBar = document.getElementById('tabBar');
            tabBar.innerHTML = '';
            // æ¸…ç©º Tab Content (åªä¿ç•™ expenses, stats, packing, documents, backup, manager)
            const itinerarySection = document.getElementById('itinerarySection');
            document.querySelectorAll('.tab-content:not([data-tab-content-id="expenses"]):not([data-tab-content-id="stats"]):not([data-tab-content-id="packing"]):not([data-tab-content-id="documents"]):not([data-tab-content-id="backup"]):not([data-tab-content-id="manager"])').forEach(el => el.remove());

            // é‡æ–°å»ºç«‹ Tab Buttons å’Œ Tab Contents
            const fixedTabs = [
                { id: "expenses", title: "ğŸ’° è²»ç”¨æ¸…å–®" },
                { id: "manager", title: "â• è¡Œç¨‹ç®¡ç†" }, // æ–°å¢çš„ç®¡ç†é ç±¤
                { id: "stats", title: "ğŸ“Š æ”¯å‡ºçµ±è¨ˆ" },
                { id: "packing", title: "ğŸ“¦ æ‰“åŒ…æ¸…å–®" },
                { id: "documents", title: "ğŸ“„ æ–‡ä»¶æ¸…å–®" },
                { id: "backup", title: "ğŸ’¾ å„²å­˜ä¿®å¾©" }
            ];

            // çµ„åˆæ‰€æœ‰é ç±¤ï¼Œä¸¦ç¢ºä¿ Day é ç±¤åœ¨ Manager é ç±¤ä¹‹å‰
            const dayTabs = ITINERARY_TABS.filter(t => t.id.startsWith('day')).sort((a, b) => a.id.localeCompare(b.id));
            
            let allTabs = [fixedTabs[0]]; // expenses
            allTabs = allTabs.concat(dayTabs); // days
            allTabs.push(fixedTabs[1]); // manager
            allTabs = allTabs.concat(fixedTabs.slice(2)); // stats, packing, documents, backup
            
            allTabs.forEach(tab => {
                // å‰µå»º Button
                const newButton = document.createElement('button');
                newButton.classList.add('tab-button');
                newButton.setAttribute('data-tab-id', tab.id);
                newButton.textContent = tab.title;
                newButton.addEventListener('click', function() { switchTab(this.getAttribute('data-tab-id')); });
                tabBar.appendChild(newButton);

                // å‰µå»º Day Content (å¦‚æœä¸å­˜åœ¨ä¸”ä¸æ˜¯å›ºå®šé ç±¤)
                if (tab.id.startsWith('day') && !document.querySelector(`.tab-content[data-tab-content-id="${tab.id}"]`)) {
                    const newContent = document.createElement('div');
                    newContent.classList.add('tab-content');
                    newContent.setAttribute('data-tab-content-id', tab.id);
                    // å°‹æ‰¾æ’å…¥é»
                    let insertAfterContent = document.querySelector(`.tab-content[data-tab-content-id="day${parseInt(tab.id.substring(3)) - 1}"]`) || document.querySelector('.tab-content[data-tab-content-id="expenses"]');
                    let nextContent = insertAfterContent ? insertAfterContent.nextElementSibling : itinerarySection.firstChild;
                    itinerarySection.insertBefore(newContent, nextContent);
                }
            });

            // æ¸²æŸ“è¡Œç¨‹å…§å®¹
            renderItinerary();
            
            // 3. è¼‰å…¥æ‰“åŒ…æ¸…å–®
            PACKING_LIST = data.packingList || [];
            renderPackingList();

            // 4. è¼‰å…¥æ–‡ä»¶æ¸…å–®
            DOCUMENTS = data.documents || [];
            renderDocumentList();

            // 5. è¼‰å…¥åŒ¯ç‡
            if (rateInput && data.exchangeRate) {
                rateInput.value = data.exchangeRate;
            }

            // 6. æ›´æ–°ç¸½è¨ˆã€é¸æ“‡å™¨ã€ç·¨è¼¯äº‹ä»¶
            sortAndFilterExpenses(); // è¼‰å…¥å¾Œå…ˆåŸ·è¡Œä¸€æ¬¡ç¯©é¸æ’åºå’Œç¸½è¨ˆ
            loadDaySelector();
            initEditableContent();
            updateAllMapLinks(); // æ›´æ–°åœ°åœ–é€£çµ
            document.getElementById('lastSaveTime').textContent = data.saveTime || 'ç„¡è¨˜éŒ„';

        } catch (e) {
            console.error("è¼‰å…¥æ•¸æ“šå¤±æ•—:", e);
            alert(`è¼‰å…¥å„²å­˜çš„è³‡æ–™å¤±æ•— (${e.message})ï¼Œå°‡ä½¿ç”¨é è¨­å€¼ã€‚`);
            localStorage.removeItem(STORAGE_KEY); // æ¸…é™¤æå£çš„è³‡æ–™
            loadData(); // é‡æ–°è¼‰å…¥é è¨­å€¼
        }
    }

    // å°‡ ITINERARY æ•¸æ“šæ¸²æŸ“åˆ° DOM ä¸­
    function renderItinerary() {
        for (const dayId in ITINERARY) {
            const tabContent = document.querySelector(`.tab-content[data-tab-content-id="${dayId}"]`);
            if (tabContent) {
                tabContent.innerHTML = ITINERARY[dayId].map(activity => renderActivityCard(activity, dayId)).join('');
            }
        }
    }

    // æ¸…é™¤æ‰€æœ‰æ•¸æ“š
    function resetData() {
        if (!confirm('ğŸš¨ è­¦å‘Šï¼šé€™å°‡æ°¸ä¹…åˆªé™¤æ‰€æœ‰å„²å­˜çš„è³‡æ–™ (åŒ…æ‹¬è²»ç”¨ã€è¡Œç¨‹ã€æ¸…å–®ç­‰)ã€‚ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
            return;
        }
        localStorage.removeItem(STORAGE_KEY);
        alert('æ‰€æœ‰è³‡æ–™å·²é‡ç½®ç‚ºé è¨­å€¼ï¼è«‹é‡æ–°æ•´ç†é é¢ã€‚');
        // é‡æ–°æ•´ç†é é¢ä¾†å®Œæˆé‡ç½®
        window.location.reload();
    }

    // åŒ¯å‡ºè³‡æ–™ (è¤‡è£½åˆ°å‰ªè²¼æ¿)
    function exportData() {
        getItineraryData(); // ç¢ºä¿è¡Œç¨‹æ•¸æ“šæ˜¯æœ€æ–°çš„
        const rawData = localStorage.getItem(STORAGE_KEY);
        
        if (!rawData) {
            alert('æ²’æœ‰å„²å­˜çš„è³‡æ–™å¯ä»¥åŒ¯å‡ºã€‚');
            return;
        }

        try {
            const data = JSON.parse(rawData);
            const formattedData = JSON.stringify(data, null, 2);
            
            navigator.clipboard.writeText(formattedData).then(() => {
                alert('å‚™ä»½è³‡æ–™ (JSON æ ¼å¼) å·²æˆåŠŸè¤‡è£½åˆ°å‰ªè²¼æ¿ï¼\næ‚¨å¯ä»¥å°‡å…¶è²¼åˆ°ç­†è¨˜æœ¬æˆ–æ–‡ä»¶ä¸­å„²å­˜ã€‚');
            }).catch(err => {
                console.error('è¤‡è£½å¤±æ•—: ', err);
                alert('è¤‡è£½åˆ°å‰ªè²¼æ¿å¤±æ•—ï¼Œè«‹æŸ¥çœ‹æ§åˆ¶å°éŒ¯èª¤ã€‚');
            });
            
        } catch (e) {
            alert('å„²å­˜çš„è³‡æ–™æ ¼å¼ä¸æ­£ç¢ºï¼Œç„¡æ³•åŒ¯å‡ºã€‚');
        }
    }

    // è¼‰å…¥è³‡æ–™ (å¾è¼¸å…¥æ¡†)
    function importData() {
        const backupData = prompt("è«‹è²¼ä¸Šæ‚¨çš„å‚™ä»½è³‡æ–™ (JSON æ ¼å¼):\n\næ³¨æ„ï¼šé€™å°‡æœƒè¦†è“‹æ‚¨ç•¶å‰å„²å­˜åœ¨ç€è¦½å™¨ä¸­çš„æ‰€æœ‰æ•¸æ“šï¼");
        
        if (backupData === null || backupData.trim() === '') {
            return; 
        }

        try {
            const data = JSON.parse(backupData);
            
            // ç°¡å–®é©—è­‰çµæ§‹
            if (!data.expenses || !data.itinerary || !data.dayCounter) {
                throw new Error('è³‡æ–™çµæ§‹ä¸å®Œæ•´ã€‚');
            }

            // å°‡æ–°æ•¸æ“šå¯«å…¥ Local Storage
            localStorage.setItem(STORAGE_KEY, backupData);
            alert('è³‡æ–™åŒ¯å…¥æˆåŠŸï¼å³å°‡é‡æ–°è¼‰å…¥é é¢ã€‚');
            window.location.reload();

        } catch (e) {
            alert('åŒ¯å…¥å¤±æ•—ï¼šæ‚¨è²¼ä¸Šçš„è³‡æ–™ä¸æ˜¯æœ‰æ•ˆçš„ JSON æ ¼å¼æˆ–è³‡æ–™çµæ§‹ä¸å®Œæ•´ã€‚');
            console.error('åŒ¯å…¥éŒ¯èª¤:', e);
        }
    }

</script>
</body>
</html>