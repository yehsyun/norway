<!DOCTYPE html>
<html lang="zh-TW">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>ğŸ‡³ğŸ‡´ Norway â„ï¸</title>
    <link rel="stylesheet" href="leaflet/leaflet.css"> 
    <script src="leaflet/leaflet.js"></script>

   <style>
       /* ==================================== */
       /* è«è˜­è¿ªè‰²ç³» CSS æ¨£å¼ (å¾®èª¿) */
       /* ==================================== */
       body {
           font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
           background-color: #f7f7f7; /* <-- æ¥µæ·ºä¸­æ€§ç° */
           color: #333;
           margin: 0;
           padding: 20px;
       }

       /* æ–°å¢é›ªèŠ±å‹•ç•«æ¨£å¼ */
       .snow {
           position: fixed;
           top: 0;
           left: 0;
           width: 100%;
           height: 100%;
           pointer-events: none;
           z-index: 100;
       }

       /* è®“é›ªèŠ±ä¸‹é™çš„å‹•ç•« */
       @keyframes snowfall {
           0% { transform: translateY(-100vh);
           }
           100% { transform: translateY(100vh);
           }
       }
        
       .snow::before {
           content: "";
           position: absolute;
           width: 1px;
           height: 1px;
           background: transparent;
           border-radius: 50%;
           box-shadow:
               5vw 0vh #aab8c2, 15vw 10vh #aab8c2, 25vw 20vh #aab8c2, 35vw 30vh #aab8c2, 45vw 40vh #aab8c2,
               55vw 50vh #aab8c2, 65vw 60vh #aab8c2, 75vw 70vh #aab8c2, 85vw 80vh #aab8c2, 95vw 90vh #aab8c2,
               2vw 5vh #aab8c2, 12vw 15vh #aab8c2, 22vw 25vh #aab8c2, 32vw 
           35vh #aab8c2, 42vw 45vh #aab8c2,
  
              52vw 55vh #aab8c2, 62vw 65vh #aab8c2, 72vw 75vh #aab8c2, 82vw 85vh #aab8c2, 92vw 95vh #aab8c2,
               1vw 3vh #aab8c2, 11vw 13vh #aab8c2, 21vw 23vh #aab8c2, 31vw 33vh #aab8c2, 41vw 43vh #aab8c2,
               51vw 53vh #aab8c2, 61vw 63vh #aab8c2, 71vw 73vh #aab8c2, 81vw 83vh #aab8c2, 
           91vw 93vh #aab8c2;
           animation: snowfall 30s linear infinite; /* è¼ƒæ…¢çš„é€Ÿåº¦ */
           opacity: 0.15;
       }

       .snow::after {
           content: "";
           position: absolute;
           width: 2px;
           height: 2px;
           background: transparent;
           border-radius: 50%;
           box-shadow:
               0vw 5vh #aab8c2, 10vw 15vh #aab8c2, 20vw 25vh #aab8c2, 30vw 35vh #aab8c2, 40vw 45vh #aab8c2,
               50vw 55vh #aab8c2, 60vw 65vh #aab8c2, 70vw 75vh #aab8c2, 80vw 85vh #aab8c2, 90vw 95vh #aab8c2,
               8vw 2vh #aab8c2, 18vw 12vh #aab8c2, 28vw 22vh #aab8c2, 38vw 32vh #aab8c2, 
           48vw 42vh #aab8c2;
           animation: snowfall 15s linear infinite;
           animation-delay: 5s;
           opacity: 0.25;
       }

       .container {
           max-width: 900px;
           margin: 0 auto;
           background-color: #ffffff;
           padding: 30px;
           border-radius: 8px;
           box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
           position: relative;
           z-index: 200;
       }

       h1 {
           color: #4a6984;
           text-align: center;
           border-bottom: 3px solid #4a6984;
           padding-bottom: 15px;
           margin-bottom: 30px;
       }

       /* --- è²»ç”¨è¼¸å…¥å€å¡Šæ¨£å¼ --- */
       .input-form {
           background-color: #f7f4e9;
           padding: 20px;
           border-radius: 5px;
           margin-top: 30px;
           margin-bottom: 30px;
           display: flex;
           gap: 15px;
           flex-wrap: wrap;
           align-items: flex-end;
       }

       .form-group {
           display: flex;
           flex-direction: column;
       }

       .form-group label {
           font-weight: bold;
           margin-bottom: 5px;
           color: #4a6984;
           font-size: 0.9em;
       }

       .input-form input, .input-form select,
       .itinerary-manager input, .itinerary-manager select {
           padding: 10px;
           border: 1px solid #c9d2d6;
           border-radius: 4px;
           font-size: 1em;
           width: 100%;
           box-sizing: border-box;
       }

       .add-button {
           padding: 10px 20px;
           background-color: #9b7673;
           color: white;
           border: none;
           border-radius: 4px;
           cursor: pointer;
           font-weight: bold;
           transition: background-color 0.3s;
           min-width: 100px;
       }

       .add-button:hover {
           background-color: #7d605e;
       }

       /* --- è¡Œç¨‹ç®¡ç†å€å¡Šæ¨£å¼ --- */
       .itinerary-manager {
           background-color: #e8e4d9;
           border: 1px solid #d3d3e6;
           padding: 20px;
           border-radius: 5px;
           margin-top: 20px;
           margin-bottom: 0;
       }

       .itinerary-manager h2 {
           margin-top: 0;
           background-color: #4a6984 !important;
           color: white !important;
           border-left: 5px solid #2e4d69;
           cursor: default;
           padding: 12px 15px;
           border-radius: 5px;
       }

       .manager-group {
           margin-bottom: 15px;
       }

       .manager-group label {
           font-weight: bold;
           display: block;
           margin-bottom: 5px;
           color: #9b7673;
       }

       .manager-group .input-row {
           display: flex;
           gap: 10px;
       }

       .manager-group .input-row input,
       .manager-group .input-row select {
           flex-grow: 1;
       }

       /* --- è²»ç”¨å¡ç‰‡æ¨£å¼ --- */
       .expense-list {
           display: flex;
           flex-direction: column;
           gap: 10px;
           margin-bottom: 20px;
       }

       .expense-card {
           display: flex;
           align-items: center;
           background-color: #f8f8f8;
           border: 1px solid #c9d2d6;
           border-radius: 5px;
           padding: 15px;
           box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
       }

       .card-icon {
           font-size: 2em;
           margin-right: 15px;
           flex-shrink: 0;
       }

       .card-main-info {
           flex-grow: 1;
       }

       .card-description {
           font-weight: bold;
           color: #333;
           margin-bottom: 3px;
       }

       .card-meta {
           font-size: 0.9em;
           color: #666;
       }

       .card-amounts {
           text-align: right;
           margin-left: 15px;
           flex-shrink: 0;
       }

       .amount-ntd {
           font-size: 1.2em;
           color: #9b7673;
           font-weight: bold;
       }

       .amount-nok {
           font-size: 0.9em;
           color: #4a6984;
       }

       .delete-card-btn {
           background-color: #c97c77;
           color: white;
           border: none;
           padding: 8px 10px;
           margin-left: 10px;
           cursor: pointer;
           border-radius: 3px;
           font-size: 0.9em;
           transition: background-color 0.3s;
           flex-shrink: 0;
       }

       .delete-card-btn:hover {
           background-color: #a86460;
       }

       /* --- è²»ç”¨ç¸½è¨ˆèˆ‡ç¯©é¸å·¥å…·æ¨£å¼ --- */
       .cost-summary {
           background-color: #f0ede5;
           padding: 15px;
           border-radius: 5px;
           display: flex;
           justify-content: space-between;
           align-items: center;
           font-size: 1.1em;
           font-weight: bold;
           margin-bottom: 20px;
       }

       .total-amount-display {
           color: #9b7673;
           font-size: 1.5em;
       }

       .filter-sort-bar {
           display: flex;
           gap: 10px;
           align-items: center;
           margin-bottom: 15px;
           background-color: #f0f7f9;
           padding: 10px;
           border-radius: 5px;
       }

       .filter-sort-bar label {
           font-weight: normal;
           color: #4a6984;
           flex-shrink: 0;
       }

       .filter-sort-bar select {
           padding: 8px;
           border-radius: 4px;
           border: 1px solid #c9d2d6;
       }

       /* --- æ”¯å‡ºçµ±è¨ˆè¡¨æ ¼æ¨£å¼ --- */
       .stats-table {
           width: 100%;
           border-collapse: collapse;
           font-size: 1em;
           text-align: left;
           margin-top: 15px;
       }

       .stats-table th, .stats-table td {
           border: 1px solid #c9d2d6;
           padding: 10px;
       }

       .stats-table th {
           background-color: #4a6984;
           color: white;
           font-weight: bold;
           text-align: center;
       }

       .stats-table tr:nth-child(even) {
           background-color: #f0f7f9;
       }

       .stats-table .total-row td {
           background-color: #f7e1e1;
           font-weight: bold;
           color: #9b7673;
           font-size: 1.1em;
       }

       .stats-table .percentage-cell {
           text-align: right;
       }

       /* ==================================== */
       /* æ©«å‘æ¨™ç±¤é  (Tabs) æ¨£å¼ */
       /* ==================================== */

       .tab-bar {
           display: flex;
           overflow-x: auto;
           white-space: nowrap;
           border-bottom: 2px solid #9b7673;
           margin-bottom: 0;
           padding-bottom: 0;
           user-select: none;
           -webkit-overflow-scrolling: touch;
       }

       .tab-button {
           padding: 10px 15px;
           cursor: pointer;
           background-color: #e0e7e8;
           color: #4a6984;
           border: 1px solid #c9d2d6;
           border-bottom: none;
           border-top-left-radius: 5px;
           border-top-right-radius: 5px;
           margin-right: 5px;
           transition: background-color 0.3s, color 0.3s;
           flex-shrink: 0;
           font-weight: bold;
           text-align: center;
           line-height: 1.3;
       }

       .tab-button.active {
           background-color: #ffffff;
           color: #9b7673;
           border-color: #9b7673;
           border-bottom: 2px solid #ffffff;
           z-index: 10;
           position: relative;
       }

       .tab-content {
           border: 1px solid #9b7673;
           padding: 20px;
           background-color: #ffffff;
           border-radius: 0 5px 5px 5px;
           margin-top: -1px;
           display: none;
           flex-direction: column;
           gap: 10px;
       }

       .tab-content.active {
           display: flex;
       }

       /* ==================================== */
       /* è¡Œç¨‹å¡ç‰‡æ¨£å¼ */
       /* ==================================== */

       .activity-card {
           display: flex;
           flex-direction: column;
           align-items: flex-start;
           background-color: #f8f8f8;
           border: 1px solid #e0e7e8;
           border-left: 5px solid #4a6984;
           border-radius: 5px;
           padding: 10px 40px 10px 15px;
           box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
           gap: 5px;
           position: relative;
       }

       .card-time {
           padding-bottom: 5px;
           margin-bottom: 5px;
           border-bottom: 1px solid #c9d2d6;
           font-weight: bold;
           color: #4a6984;
           line-height: 1.4;
           font-size: 1.1em;
           outline: none;
       }
       
       .card-time[contenteditable="true"]:focus {
            box-shadow: 0 0 0 1px #e6e6fa;
            border-radius: 3px;
       }

       .card-activity-details {
           flex-grow: 1;
           display: flex;
           flex-direction: column;
           line-height: 1.4;
       }

       /* å…§å®¹å¯ç·¨è¼¯å€å¡Šæ¨£å¼ - ç”¨æ–¼æ´»å‹•æè¿° */
       .editable-content {
           flex-grow: 1;
           padding: 0 5px;
           transition: box-shadow 0.2s;
           outline: none;
           cursor: text;
           margin-bottom: 5px;
           font-size: 1.1em;
           min-height: 1.2em;
       }

       .editable-content:focus {
           box-shadow: 0 0 0 2px #e6e6fa;
           border-radius: 3px;
       }

       /* åœ°åœ–é€£çµå®¹å™¨ */
       .card-map-links {
           display: flex;
           gap: 8px;
           margin-top: 5px;
       }

       a.map-link {
           color: #6a8ba2;
           font-size: 0.9em;
           text-decoration: none;
           font-weight: bold;
           cursor: pointer;
           flex-shrink: 0;
           line-height: 1;
           display: flex;
           align-items: center;
           padding: 3px 5px;
           border: 1px solid #d3d3e6;
           border-radius: 3px;
           background-color: #f0f7f9;
       }

       a.map-link:hover {
           background-color: #e0e7e8;
           color: #4a6984;
       }
       
       /* ç·¨è¼¯åœ°åœ–æŒ‰éˆ•ç‰¹åˆ¥æ¨£å¼ */
       a.map-link.edit-link {
           color: #9b7673;
           background-color: #f7e1e1; 
           border-color: #e1c4c4;
       }


       .delete-btn {
           background-color: #c97c77;
           color: white;
           border: none;
           padding: 5px 8px;
           position: absolute;
           top: 10px;
           right: 10px;
           cursor: pointer;
           border-radius: 3px;
           font-size: 0.9em;
           transition: background-color 0.3s;
           flex-shrink: 0;
       }

       .delete-btn:hover {
           background-color: #a86460;
       }

       /* ç‰¹æ®Šè¡Œç¨‹é …ç›®æ¨£å¼ - äº¤é€š/ä½å®¿ */
       .transport-item {
           border-left-color: #6a8ba2;
           background-color: #f0f7f9;
       }

       .lodging-item {
           border-left-color: #9b7673;
           background-color: #f9f0f0;
       }

       .highlight {
           font-weight: bold;
           color: #4a6984;
       }
       /* ==================================== */
       /* Packing List & Documents CSS */
       /* ==================================== */
       .packing-item, .document-item {
           display: flex;
           justify-content: space-between;
           align-items: center;
           padding: 10px;
           border-bottom: 1px dashed #eee;
           cursor: pointer;
           transition: background-color 0.1s;
       }
       .packing-item:hover, .document-item:hover {
           background-color: #f9f9f9;
       }
       .packing-item.checked {
          opacity: 0.6;
          background-color: #f0f0f0;
       }
       .packing-item.checked .card-description::before {
          content: "âœ… ";
          font-weight: bold;
       }
       .packing-item .card-main-info {
          cursor: pointer;
          flex-grow: 1;
       }
       .doc-link {
           color: #4a6984;
           text-decoration: none;
           font-weight: bold;
       }
       .document-list {
           display: flex;
           flex-direction: column;
           gap: 10px;
       }
       .document-card {
           background-color: #f0f7f9;
           border: 1px solid #c9d2d6;
           border-radius: 5px;
           padding: 15px;
           display: flex;
           justify-content: space-between;
           align-items: center;
           box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
           font-size: 1.1em;
       }
       .document-title {
           font-weight: bold;
           color: #4a6984;
           flex-grow: 1;
       }
   </style>
</head>
<body>

<div class="snow"></div>

<div class="container">
   <h1>ğŸ‡³ğŸ‡´ Norway â„ï¸</h1>
   <div id="itinerarySection" class="itinerary-section">
       <div class="tab-bar" id="tabBar">
           <button class="tab-button active" data-tab-id="expenses">ğŸ’° è²»ç”¨æ¸…å–®</button>
           <button class="tab-button" data-tab-id="day1">ğŸ—“ï¸ Day 1: 12/5</button>
           <button class="tab-button" data-tab-id="day2">ğŸ—“ï¸ Day 2: 12/6</button>
           <button class="tab-button" data-tab-id="day3">ğŸ—“ï¸ Day 3: 12/7</button>
        
           <button class="tab-button" data-tab-id="day4">ğŸ—“ï¸ Day 4: 12/8</button>
           <button class="tab-button" data-tab-id="day5">ğŸ—“ï¸ Day 5: 12/9</button>
           <button class="tab-button" data-tab-id="day6">ğŸ—“ï¸ Day 6: 12/10</button>
           <button class="tab-button" data-tab-id="day7">ğŸ—“ï¸ Day 7: 12/11</button>
           <button class="tab-button" data-tab-id="day8">ğŸ—“ï¸ Day 8: 12/12</button>
           <button class="tab-button" data-tab-id="day9">ğŸ—“ï¸ Day 9: 12/13</button>
           <button 
                class="tab-button" data-tab-id="day10">ğŸ—“ï¸ Day 10: 12/14</button>
           <button class="tab-button" data-tab-id="day11">ğŸ—“ï¸ Day 11: 12/15</button>
           <button class="tab-button" data-tab-id="day12">ğŸ—“ï¸ Day 12: 12/16</button>
           <button class="tab-button" data-tab-id="stats">ğŸ“Š æ”¯å‡ºçµ±è¨ˆ</button> 
           <button class="tab-button" data-tab-id="packing">ğŸ“¦ æ‰“åŒ…æ¸…å–®</button>
           <button class="tab-button" data-tab-id="documents">ğŸ“„ æ–‡ä»¶æ¸…å–®</button>
           <button class="tab-button" data-tab-id="backup">ğŸ’¾ å„²å­˜ä¿®å¾©</button>
       
       </div>

        <div class="tab-content active" data-tab-content-id="expenses">
           <h2>æ–°å¢/ç®¡ç†æ”¯å‡º ğŸ’¸</h2>
           <div class="input-form">
               <div class="form-group">
                   <label for="expenseDate">æ—¥æœŸ</label>
                   <input type="date" id="expenseDate" value="2025-12-05">
       
                </div>
               <div class="form-group">
                   <label for="expenseCategory">é¡åˆ¥</label>
                   <select id="expenseCategory">
                       <option value="é£²é£Ÿ">é£²é£Ÿ ğŸ•</option>
           
                       <option value="äº¤é€š">äº¤é€š âœˆï¸</option>
                       <option value="ä½å®¿">ä½å®¿ ğŸ¨</option>
                       <option value="è³¼ç‰©">è³¼ç‰© ğŸ›ï¸</option>
                       <option value="æ´»å‹•">æ´»å‹• â›·ï¸</option>
           
                       <option value="å…¶ä»–">å…¶ä»– â“</option>
                   </select>
               </div>
               <div class="form-group">
                   <label for="expenseDescription">æè¿°</label>
                
                   <input type="text" id="expenseDescription" placeholder="è¼¸å…¥æ¶ˆè²»æè¿°">
               </div>
               <div class="form-group" style="width: 120px;
                flex-shrink: 0;">
                    <label for="currentExchangeRate">ç•¶å‰åŒ¯ç‡ (1 NOK = ? NTD)</label>
                    <input type="number" id="currentExchangeRate" placeholder="ä¾‹å¦‚: 3.00" value="3.00" step="0.01" min="0.01">
                </div>
               <div class="form-group" style="width: 100px;
                flex-shrink: 0;">
                   <label for="expenseAmountNOK">æŒªå¨å…‹æœ— (NOK)</label>
                   <input type="number" id="expenseAmountNOK" placeholder="é‡‘é¡" min="1">
               </div>
               <button class="add-button" onclick="addExpense()" style="background-color: #9b7673;">æ–°å¢æ”¯å‡º</button>
           </div>
          
           <div class="filter-sort-bar">
               <label for="expenseFilter">ç¯©é¸é¡åˆ¥:</label>
               <select id="expenseFilter" onchange="sortAndFilterExpenses()">
                   <option value="all">æ‰€æœ‰é¡åˆ¥</option>
                   <option value="é£²é£Ÿ">é£²é£Ÿ ğŸ•</option>
             
                   <option value="äº¤é€š">äº¤é€š âœˆï¸</option>
                   <option value="ä½å®¿">ä½å®¿ ğŸ¨</option>
                   <option value="è³¼ç‰©">è³¼ç‰© ğŸ›ï¸</option>
                   <option value="æ´»å‹•">æ´»å‹• â›·ï¸</option>
                   <option value="å…¶ä»–">å…¶ä»– â“</option>
               </select>
               <label for="expenseSort">æ’åºæ–¹å¼:</label>
               <select id="expenseSort" onchange="sortAndFilterExpenses()">
                   <option value="date_desc">æ—¥æœŸ (æ–°åˆ°èˆŠ)</option>
                   <option value="date_asc">æ—¥æœŸ (èˆŠåˆ°æ–°)</option>
                   <option value="ntd_desc">é‡‘é¡ (é«˜åˆ°ä½)</option>
                   <option value="ntd_asc">é‡‘é¡ (ä½åˆ°é«˜)</option>
                   <option value="category_asc">é¡åˆ¥åç¨±</option>
               </select>
           </div>

           <div class="cost-summary">
               <span>ğŸ’° ç¸½è¨ˆè²»ç”¨ (NTD ä¼°ç®—):</span>
               <span class="total-amount-display">NTD <span id="totalAmount">35,810</span></span>
               <span style="font-size: 0.9em; color: #4a6984;">(NOK: <span id="totalNokAmount">11,937</span>)</span>
           </div>

           <div id="expenseBody" class="expense-list">
               <div class="expense-card" data-category="ä½å®¿" data-amount="20000" data-nok="6667" data-rate="3.00" data-date-str="12/12" data-iso-date="2025-12-12">
                   <span class="card-icon">ğŸ¨</span>
                   <div class="card-main-info">
                       <div class="card-description">CLARION HOTEL THE EDGE å…©æ™š</div>
                       <div class="card-meta">ä½å®¿ Â· 12/12 (åŒ¯ç‡ 3.00)</div>
                   </div>
                   <div class="card-amounts">
                       <div class="amount-ntd">NTD 20,000</div>
                       <div class="amount-nok">NOK 6,667</div>
                   </div>
                   <button class="delete-card-btn" onclick="deleteCard(this)">åˆªé™¤</button>
               </div>
               <div class="expense-card" data-category="äº¤é€š" data-amount="15000" data-nok="5000" data-rate="3.00" data-date-str="12/05" data-iso-date="2025-12-05">
                   <span class="card-icon">âœˆï¸</span>
                   <div class="card-main-info">
                       <div class="card-description">å°ç£-æŒªå¨ ä¾†å›æ©Ÿç¥¨</div>
                       <div class="card-meta">äº¤é€š Â· 12/05 (åŒ¯ç‡ 3.00)</div>
                   </div>
                   <div class="card-amounts">
                       <div class="amount-ntd">NTD 15,000</div>
                       <div class="amount-nok">NOK 5,000</div>
                   </div>
                   <button class="delete-card-btn" onclick="deleteCard(this)">åˆªé™¤</button>
               </div>
               <div class="expense-card" data-category="é£²é£Ÿ" data-amount="810" data-nok="270" data-rate="3.00" data-date-str="12/05" data-iso-date="2025-12-05">
                   <span class="card-icon">ğŸ•</span>
                   <div class="card-main-info">
                       <div class="card-description">æ©Ÿå ´ç°¡é¤</div>
                       <div class="card-meta">é£²é£Ÿ Â· 12/05 (åŒ¯ç‡ 3.00)</div>
                   </div>
                   <div class="card-amounts">
                       <div class="amount-ntd">NTD 810</div>
                       <div class="amount-nok">NOK 270</div>
                   </div>
                   <button class="delete-card-btn" onclick="deleteCard(this)">åˆªé™¤</button>
               </div>
           </div>
       </div> <div class="tab-content" data-tab-content-id="day1">
           <div class="activity-card transport-item" data-activity-id="1703271600000" data-type="transport">
                <div class="delete-btn" onclick="deleteActivityCard(this)">åˆªé™¤</div>
                <div class="card-time" contenteditable="true">15:30</div>
                <div class="card-activity-details">
                    <div class="editable-content" contenteditable="true">æ­ä¹˜æ©Ÿå ´å·´å£«å‰å¾€é£¯åº—</div>
                    <div class="card-map-links"></div>
                </div>
            </div>
            <div class="activity-card lodging-item" data-activity-id="1703271600001" data-type="lodging">
                <div class="delete-btn" onclick="deleteActivityCard(this)">åˆªé™¤</div>
                <div class="card-time" contenteditable="true">ä½å®¿</div>
                <div class="card-activity-details">
                    <div class="editable-content" contenteditable="true">Radisson Blu Hotel, TromsÃ¸ (å·²é è¨‚)</div>
                    <div class="card-map-links"></div>
                </div>
            </div>
       </div>
       <div class="tab-content" data-tab-content-id="day2">
           <div class="activity-card" data-activity-id="1703271600002" data-type="activity">
                <div class="delete-btn" onclick="deleteActivityCard(this)">åˆªé™¤</div>
                <div class="card-time" contenteditable="true">09:00</div>
                <div class="card-activity-details">
                    <div class="editable-content" contenteditable="true">åƒè§€ <span class='highlight'>ç‰¹ç¾…å§†ç‘Ÿåšç‰©é¤¨ (TromsÃ¸ Museum)</span></div>
                    <div class="card-map-links"></div>
                </div>
            </div>
            <div class="activity-card" data-activity-id="1703271600003" data-type="activity">
                <div class="delete-btn" onclick="deleteActivityCard(this)">åˆªé™¤</div>
                <div class="card-time" contenteditable="true">13:00</div>
                <div class="card-activity-details">
                    <div class="editable-content" contenteditable="true">åˆé¤ï¼šè©¦è©¦åŒ—æ¥µæµ·é®®æ¹¯</div>
                    <div class="card-map-links"></div>
                </div>
            </div>
            <div class="activity-card" data-activity-id="1703271600004" data-type="activity">
                <div class="delete-btn" onclick="deleteActivityCard(this)">åˆªé™¤</div>
                <div class="card-time" contenteditable="true">19:00</div>
                <div class="card-activity-details">
                    <div class="editable-content" contenteditable="true">åŒ—æ¥µå…‰è¿½é€ä¹‹æ—… (å·²é è¨‚)</div>
                    <div class="card-map-links"></div>
                </div>
            </div>
       </div>
       <div class="tab-content" data-tab-content-id="day3"></div>
       <div class="tab-content" data-tab-content-id="day4"></div>
       <div class="tab-content" data-tab-content-id="day5"></div>
       <div class="tab-content" data-tab-content-id="day6"></div>
       <div class="tab-content" data-tab-content-id="day7"></div>
       <div class="tab-content" data-tab-content-id="day8"></div>
       <div class="tab-content" data-tab-content-id="day9"></div>
       <div class="tab-content" data-tab-content-id="day10"></div>
       <div class="tab-content" data-tab-content-id="day11"></div>
       <div class="tab-content" data-tab-content-id="day12"></div>
       
       <div class="itinerary-manager"> 
           <h2>è¡Œç¨‹æ–°å¢èˆ‡ç®¡ç†</h2>
           <div class="manager-group">
               <label>æ–°å¢æ—¥æœŸ</label>
               <div class="input-row">
                   <input type="text" id="newDayTitle" placeholder="ä¾‹å¦‚: Day 13: 12/17" style="flex-grow: 1;">
                   <button class="add-button" onclick="addDayTab()" style="flex-shrink: 0;">+ æ–°å¢ä¸€å¤©</button>
               </div>
           </div>
           <div class="manager-group">
               <label>æ–°å¢ç•¶æ—¥æ´»å‹•</label>
               <div class="input-row">
                   <select id="daySelector" style="width: 30%; flex-shrink: 0;">
                       </select>
                   <input type="text" id="newActivityTime" placeholder="æ™‚é–“/æ¨™é¡Œ (å¿…å¡«)" style="flex-grow: 1; min-width: 100px;">
               </div>
               <div class="input-row" style="margin-bottom: 10px;">
                   <input type="text" id="newActivityDescription" placeholder="æ´»å‹•æè¿° (å¿…å¡«)">
                   <select id="newActivityType" style="width: 25%;
                    flex-shrink: 0;">
                       <option value="activity">ä¸€èˆ¬æ´»å‹•</option>
                       <option value="transport">äº¤é€š ğŸš</option>
                       <option value="lodging">ä½å®¿ ğŸ¨</option>
                   </select>
               </div>
               <div class="input-row">
                   <input type="text" id="newActivityMapUrl" placeholder="åœ°åœ– URL (é¸å¡«, è¼¸å…¥å¾Œæœƒè¦†è“‹è‡ªå‹•æœå°‹)">
                   <button class="add-button" onclick="addActivityToDay()" style="flex-shrink: 0;">æ–°å¢æ´»å‹•</button>
               </div>
           </div>
       </div>

       <div class="tab-content" data-tab-content-id="stats">
           <h2>æ”¯å‡ºé¡åˆ¥çµ±è¨ˆ ğŸ“Š</h2>
           <div id="expenseStatsContainer">
               </div>
       </div>

       <div class="tab-content" data-tab-content-id="packing">
           <h2>æ‰“åŒ…æ¸…å–® ğŸ“¦</h2>
           <div class="input-form" style="margin-bottom: 20px;">
               <div class="form-group" style="flex-grow: 1;">
                   <label for="packingItem">æ–°å¢ç‰©å“</label>
                   <input type="text" id="packingItem" placeholder="ä¾‹å¦‚: ä¿æš–ç¾½çµ¨å¤–å¥—">
               </div>
               <button class="add-button" onclick="addPackingItem()">æ–°å¢</button>
           </div>
           <div id="packingList" class="expense-list">
               </div>
       </div>
       
       <div class="tab-content" data-tab-content-id="documents">
            <h2>é‡è¦æ–‡ä»¶æ¸…å–® ğŸ“„</h2>
           <div class="input-form" style="margin-bottom: 20px;">
                <div class="form-group" style="flex-grow: 1;">
                   <label for="docTitle">æ–‡ä»¶æ¨™é¡Œ</label>
                   <input type="text" id="docTitle" placeholder="ä¾‹å¦‚: æ©Ÿç¥¨è¨‚å–®ç·¨è™Ÿ">
               </div>
               <div class="form-group" style="flex-grow: 1;">
                   <label for="docLink">é€£çµ (URL)</label>
                   <input type="text" id="docLink" placeholder="é¸å¡«: è²¼ä¸Šæ–‡ä»¶ç¶²å€">
               </div>
               <button class="add-button" onclick="addDocument()">æ–°å¢æ–‡ä»¶</button>
           </div>
           <div id="documentList" class="document-list">
               </div>
       </div>
       
       <div class="tab-content" data-tab-content-id="backup">
           <h2>è³‡æ–™å‚™ä»½èˆ‡ä¿®å¾© ğŸ’¾</h2>
           <p style="color: #9b7673; font-weight: bold;">
               æ•¸æ“šå„²å­˜åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­ (Local Storage)ï¼Œä¸æœƒè‡ªå‹•åŒæ­¥åˆ°é›²ç«¯ã€‚
               è«‹å®šæœŸå‚™ä»½ï¼Œæˆ–åœ¨åˆ‡æ›è£ç½®å‰åŸ·è¡ŒåŒ¯å‡º/åŒ¯å…¥æ“ä½œã€‚
           </p>
           <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="add-button" onclick="exportData()" style="background-color: #4a6984;">ğŸ’¾ åŒ¯å‡ºå‚™ä»½è³‡æ–™ (è¤‡è£½åˆ°å‰ªè²¼æ¿)</button>
                <button class="add-button" onclick="importData()" style="background-color: #9b7673;">â¬†ï¸ åŒ¯å…¥/ä¿®å¾©è³‡æ–™</button>
           </div>
           <p style="font-size: 0.9em; color: #666;">ä¸Šæ¬¡å„²å­˜æ™‚é–“: <span id="lastSaveTime">N/A</span></p>
       </div>

   </div> </div> <script>
    // ====================================
    // å…¨å±€è®Šæ•¸èˆ‡åˆå§‹åŒ–
    // ====================================

    const STORAGE_KEY = 'norwayPlannerData';
    // é è¨­è¡Œç¨‹çµæ§‹
    let ITINERARY = { 
        "day1": [
            { id: 1703271600000, time: "15:30", description: "æ­ä¹˜æ©Ÿå ´å·´å£«å‰å¾€é£¯åº—", type: "transport", mapUrlOverride: "" },
            { id: 1703271600001, time: "ä½å®¿", description: "Radisson Blu Hotel, TromsÃ¸ (å·²é è¨‚)", type: "lodging", mapUrlOverride: "" }
        ],
        "day2": [
            { id: 1703271600002, time: "09:00", description: "åƒè§€ <span class='highlight'>ç‰¹ç¾…å§†ç‘Ÿåšç‰©é¤¨ (TromsÃ¸ Museum)</span>", type: "activity", mapUrlOverride: "" },
            { id: 1703271600003, time: "13:00", description: "åˆé¤ï¼šè©¦è©¦åŒ—æ¥µæµ·é®®æ¹¯", type: "activity", mapUrlOverride: "" },
            { id: 1703271600004, time: "19:00", description: "åŒ—æ¥µå…‰è¿½é€ä¹‹æ—… (å·²é è¨‚)", type: "activity", mapUrlOverride: "" }
        ],
        "day3": [], "day4": [], "day5": [], "day6": [], "day7": [], "day8": [], "day9": [], "day10": [], "day11": [], "day12": [] 
    };

    // é è¨­è²»ç”¨æ¸…å–®
    const DEFAULT_EXPENSES = [
        { date: "2025-12-05", category: "äº¤é€š", description: "å°ç£-æŒªå¨ ä¾†å›æ©Ÿç¥¨", amountNOK: 5000, amountNTD: 15000, exchangeRate: 3.00 },
        { date: "2025-12-12", category: "ä½å®¿", description: "CLARION HOTEL THE EDGE å…©æ™š", amountNOK: 6667, amountNTD: 20000, exchangeRate: 3.00 },
        { date: "2025-12-05", category: "é£²é£Ÿ", description: "æ©Ÿå ´ç°¡é¤", amountNOK: 270, amountNTD: 810, exchangeRate: 3.00 }
    ];

    let EXPENSES = DEFAULT_EXPENSES;
    let PACKING_LIST = [];
    let DOCUMENTS = [];

    // é è¨­é ç±¤åˆ—è¡¨
    const DEFAULT_TABS = [
        { id: "day1", title: "ğŸ—“ï¸ Day 1: 12/5" },
        { id: "day2", title: "ğŸ—“ï¸ Day 2: 12/6" },
        { id: "day3", title: "ğŸ—“ï¸ Day 3: 12/7" },
        { id: "day4", title: "ğŸ—“ï¸ Day 4: 12/8" },
        { id: "day5", title: "ğŸ—“ï¸ Day 5: 12/9" },
        { id: "day6", title: "ğŸ—“ï¸ Day 6: 12/10" },
        { id: "day7", title: "ğŸ—“ï¸ Day 7: 12/11" },
        { id: "day8", title: "ğŸ—“ï¸ Day 8: 12/12" },
        { id: "day9", title: "ğŸ—“ï¸ Day 9: 12/13" },
        { id: "day10", title: "ğŸ—“ï¸ Day 10: 12/14" },
        { id: "day11", title: "ğŸ—“ï¸ Day 11: 12/15" },
        { id: "day12", title: "ğŸ—“ï¸ Day 12: 12/16" }
    ];

    let ITINERARY_TABS = DEFAULT_TABS;
    let dayCounter = 12;

    document.addEventListener('DOMContentLoaded', function() {
        loadData();

        // åˆå§‹åŒ– Tab é»æ“Šäº‹ä»¶
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', function() {
                switchTab(this.getAttribute('data-tab-id'));
            });
        });

        // è¨­ç½®é è¨­ Tab
        const defaultTab = document.querySelector('.tab-button[data-tab-id="expenses"]');
        if (defaultTab) {
            switchTab("expenses");
        } else {
            const firstTab = document.querySelector('.tab-button');
            if (firstTab) {
                switchTab(firstTab.getAttribute('data-tab-id'));
            }
        }
    });

    // ====================================
    // DOM æ“ä½œèˆ‡è¼”åŠ©å‡½æ•¸
    // ====================================

    // å•Ÿå‹•æ‰€æœ‰ contenteditable æ¬„ä½çš„äº‹ä»¶ç›£è½å™¨
    function initEditableContent() {
        document.querySelectorAll('.editable-content, .card-time[contenteditable="true"]').forEach(element => {
            // ç¢ºä¿ onblur äº‹ä»¶å·²ç¶å®šï¼Œä»¥è‡ªå‹•å„²å­˜
            element.removeEventListener('blur', saveData);
            element.addEventListener('blur', saveData);

            // è™•ç†è²¼ä¸Šäº‹ä»¶ï¼Œé¿å…è²¼ä¸Š HTML æ¨£å¼
            element.removeEventListener('paste', handleEditablePaste);
            element.addEventListener('paste', handleEditablePaste);

            // é‡å°æ´»å‹•å…§å®¹ï¼Œæ–°å¢ä¸€å€‹ input ç›£è½å™¨ï¼Œä»¥ä¾¿å…§å®¹æ”¹è®Šæ™‚æ›´æ–°åœ°åœ–é€£çµ
            if (element.classList.contains('editable-content')) {
                element.removeEventListener('input', handleActivityContentInput);
                element.addEventListener('input', handleActivityContentInput);
            }
        });
    }

    // å…§å®¹è®Šæ›´æ™‚ï¼Œè‡ªå‹•æ›´æ–°åœ°åœ–é€£çµ
    function handleActivityContentInput() {
        const card = this.closest('.activity-card');
        // æ‰¾åˆ°å°æ‡‰çš„æ´»å‹•å°è±¡ä¸¦æ›´æ–°å…¶æè¿° (ä»¥é˜² saveData å»¶é²)
        const dayId = card.closest('.tab-content').getAttribute('data-tab-content-id');
        const activityId = parseInt(card.getAttribute('data-activity-id'));
        const activity = ITINERARY[dayId] ? ITINERARY[dayId].find(a => a.id === activityId) : null;
        
        if(activity) {
            activity.description = this.innerHTML; // ä½¿ç”¨ innerHTML å„²å­˜é«˜äº®æ¨™ç±¤
            updateMapLinksForCard(card); // ç«‹å³æ›´æ–°åœ°åœ–é€£çµ
        }
    }

    // è™•ç†è²¼ä¸Šäº‹ä»¶ï¼Œåªä¿ç•™ç´”æ–‡å­—
    function handleEditablePaste(event) {
        event.preventDefault();
        const text = (event.clipboardData || window.clipboardData).getData('text/plain');
        document.execCommand('insertText', false, text);
        
        // ç¢ºä¿è²¼ä¸Šå¾Œè§¸ç™¼åœ°åœ–é€£çµæ›´æ–°
        if (this.classList.contains('editable-content')) {
            handleActivityContentInput.call(this);
        }
    }

    /**
     * é»æ“Šã€Œç·¨è¼¯åœ°åœ–ã€æŒ‰éˆ•æ™‚è§¸ç™¼ï¼Œè®“ç”¨æˆ¶è¼¸å…¥æˆ–æ¸…é™¤æ‰‹å‹•é€£çµã€‚
     * @param {HTMLElement} btn - é»æ“Šçš„æŒ‰éˆ•å…ƒç´ 
     */
    function editMapLink(btn) {
        const card = btn.closest('.activity-card');
        const dayId = card.closest('.tab-content').getAttribute('data-tab-content-id');
        const activityId = parseInt(card.getAttribute('data-activity-id'));
        const activity = ITINERARY[dayId] ? ITINERARY[dayId].find(a => a.id === activityId) : null;

        if (!activity) return;

        const currentUrl = activity.mapUrlOverride || '';
        const promptMessage = `è«‹è¼¸å…¥åœ°åœ–é€£çµ (Google Maps / å…¶ä»–åœ°åœ–ç¶²å€)
æˆ–è¼¸å…¥ã€Œæ¸…é™¤ã€ä»¥ä½¿ç”¨è‡ªå‹•æœå°‹ã€‚

ç•¶å‰é€£çµ: ${currentUrl || 'ç„¡ (ä½¿ç”¨è‡ªå‹•æœå°‹)'}`;

        const newUrl = prompt(promptMessage, currentUrl);

        if (newUrl === null) {
            return; // ä½¿ç”¨è€…æŒ‰å–æ¶ˆ
        }

        const trimmedUrl = newUrl.trim();

        if (trimmedUrl.toLowerCase() === 'æ¸…é™¤' || trimmedUrl === '') {
            activity.mapUrlOverride = ""; // æ¸…é™¤å„²å­˜çš„é€£çµ
            alert('å·²ç§»é™¤æ‰‹å‹•é€£çµï¼Œå°‡ä½¿ç”¨è‡ªå‹•æœå°‹ã€‚');
        } else if (trimmedUrl.startsWith('http')) {
            // å¦‚æœè¼¸å…¥äº†æœ‰æ•ˆçš„ URL
            activity.mapUrlOverride = trimmedUrl;
            // å„²å­˜æ–°çš„é€£çµ
            alert('æ‰‹å‹•é€£çµå·²è¨­å®šæˆåŠŸã€‚');
        } else {
            alert('è¼¸å…¥ç„¡æ•ˆã€‚è«‹è¼¸å…¥ä»¥ http:// æˆ– https:// é–‹é ­çš„å®Œæ•´ URLï¼Œæˆ–è¼¸å…¥ã€Œæ¸…é™¤ã€ã€‚');
            return;
        }

        saveData(); // å„²å­˜æ•¸æ“š
        updateMapLinksForCard(card); // æ›´æ–°å¡ç‰‡é¡¯ç¤º
    }

    /**
     * æ›´æ–°å–®å€‹æ´»å‹•å¡ç‰‡çš„å‹•æ…‹åœ°åœ–é€£çµé¡¯ç¤ºã€‚
     */
    function updateMapLinksForCard(card) {
        const dayId = card.closest('.tab-content').getAttribute('data-tab-content-id');
        const activityId = parseInt(card.getAttribute('data-activity-id'));
        const activity = ITINERARY[dayId] ? ITINERARY[dayId].find(a => a.id === activityId) : null;
        const editableContent = card.querySelector('.editable-content');
        const mapLinksContainer = card.querySelector('.card-map-links');

        if (!activity || !editableContent || !mapLinksContainer) {
            if(mapLinksContainer) mapLinksContainer.innerHTML = '';
            return;
        }

        let linkHtml = '';
        const savedUrl = activity.mapUrlOverride; // å¾æ•¸æ“šä¸­ç²å–æ‰‹å‹•é€£çµ
        const activityText = editableContent.innerText.trim();
        
        // 1. åˆ¤æ–·ä½¿ç”¨æ‰‹å‹•é€£çµé‚„æ˜¯è‡ªå‹•ç”Ÿæˆé€£çµ
        if (savedUrl && savedUrl.startsWith('http')) {
            // ä½¿ç”¨æ‰‹å‹•é€£çµ
            linkHtml = `<a href="${savedUrl}" target="_blank" class="map-link" title="æ‰‹å‹•è¨­å®šé€£çµ">ğŸ”— æ‰‹å‹•é€£çµ</a>`;
        } else if (activityText && activity.type === 'activity') {
            // åªå°ä¸€èˆ¬æ´»å‹•å•Ÿç”¨è‡ªå‹•æœå°‹
            // è‡ªå‹•ç”Ÿæˆé€£çµ (ä½¿ç”¨å‰ 50 å­—ä½œç‚ºæŸ¥è©¢)
            const searchQuery = activityText.substring(0, 50);
            const mapUrl = getGoogleMapsUrl(searchQuery);
            if (mapUrl) {
                linkHtml = `<a href="${mapUrl}" target="_blank" class="map-link" title="Google Maps æœå°‹: ${searchQuery}">ğŸ—ºï¸ è‡ªå‹•æœå°‹</a>`;
            }
        }

        // 2. åŠ å…¥ç·¨è¼¯æŒ‰éˆ•
        const editButtonHtml = `<a href="javascript:void(0)" onclick="editMapLink(this)" class="map-link edit-link" title="è¨­å®šæˆ–æ¸…é™¤åœ°åœ–é€£çµ">ğŸ“ ç·¨è¼¯é€£çµ</a>`;

        mapLinksContainer.innerHTML = linkHtml + editButtonHtml;
    }

    /**
     * æ›´æ–°æ‰€æœ‰åœ°åœ–é€£çµï¼Œåœ¨ loadData æˆ– saveData ä¹‹å¾Œå‘¼å«
     */
    function updateAllMapLinks() {
        document.querySelectorAll('.activity-card').forEach(updateMapLinksForCard);
    }

    /**
     * æ ¹æ“šç´”æ–‡å­—ç”Ÿæˆ Google Maps æœå°‹ URL
     */
    function getGoogleMapsUrl(query) {
        const fullQuery = `æŒªå¨ ${query.replace(/<[^>]*>?/gm, '').trim()}`; // ç§»é™¤ HTML æ¨™ç±¤
        return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(fullQuery)}`;
    }

    // Tab åˆ‡æ›åŠŸèƒ½
    function switchTab(tabId) {
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });

        const activeBtn = document.querySelector(`.tab-button[data-tab-id="${tabId}"]`);
        const activeContent = document.querySelector(`.tab-content[data-tab-content-id="${tabId}"]`);

        if (activeBtn) activeBtn.classList.add('active');
        if (activeContent) activeContent.classList.add('active');

        // é‡æ–°æ¸²æŸ“çµ±è¨ˆåœ–è¡¨ (Stat)
        if (tabId === 'stats') {
            generateExpenseStatsTable();
        }

        // ç¢ºä¿ tab-bar æ»¾å‹•åˆ°ç•¶å‰ tab
        if (activeBtn) {
            activeBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        }
    }

    // ====================================
    // è¡Œç¨‹ç®¡ç†åŠŸèƒ½
    // ====================================

    /**
     * å‰µå»ºå–®å€‹æ´»å‹•å¡ç‰‡çš„ HTML çµæ§‹
     */
    function createActivityCardHtml(activity, dayId) {
        const typeClass = activity.type === 'transport' ? 'transport-item' :
                          activity.type === 'lodging' ? 'lodging-item' : '';
        const emoji = activity.type === 'transport' ? 'ğŸš' :
                      activity.type === 'lodging' ? 'ğŸ¨' : 'ğŸ“';

        const html = `
            <div class="activity-card ${typeClass}" data-activity-id="${activity.id}" data-type="${activity.type}" data-day-id="${dayId}">
                <div class="delete-btn" onclick="deleteActivityCard(this)">åˆªé™¤</div>
                <div class="card-time" contenteditable="true">${activity.time || ''}</div>
                <div class="card-activity-details">
                    <div class="editable-content" contenteditable="true">${activity.description || ''}</div>
                    <div class="card-map-links"></div>
                </div>
            </div>
        `;
        return html;
    }

    // åˆªé™¤è¡Œç¨‹æ´»å‹•
    function deleteActivityCard(btn) {
        if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¡Œç¨‹æ´»å‹•å—ï¼Ÿ')) return;
        const card = btn.closest('.activity-card');
        const dayId = card.getAttribute('data-day-id');
        const activityId = parseInt(card.getAttribute('data-activity-id'));

        // å¾ ITINERARY æ•¸æ“šçµæ§‹ä¸­åˆªé™¤
        if (ITINERARY[dayId]) {
            ITINERARY[dayId] = ITINERARY[dayId].filter(a => a.id !== activityId);
        }

        card.remove(); // å¾ DOM ä¸­åˆªé™¤å¡ç‰‡
        saveData();
    }

    // è¼‰å…¥ Day Selector é¸é …
    function loadDaySelector() {
        const selector = document.getElementById('daySelector');
        selector.innerHTML = ''; // æ¸…ç©ºç¾æœ‰é¸é …

        // é‡æ–°å¾ ITINERARY_TABS å‰µå»ºé¸é …
        ITINERARY_TABS.forEach(tab => {
            if (tab.id.startsWith('day')) {
                const option = document.createElement('option');
                option.value = tab.id;
                option.textContent = tab.title;
                selector.appendChild(option);
            }
        });

        // é è¨­é¸å–ç•¶å‰é ç±¤ (å¦‚æœå®ƒæ˜¯ Day é ç±¤)
        const activeTabId = document.querySelector('.tab-button.active')?.getAttribute('data-tab-id');
        if (activeTabId && activeTabId.startsWith('day')) {
            selector.value = activeTabId;
        }
    }


    // æ–°å¢ä¸€å¤©è¡Œç¨‹
    function addDayTab() {
        const titleInput = document.getElementById('newDayTitle');
        const newTitle = titleInput.value.trim();

        if (newTitle === '') {
            alert('è«‹è¼¸å…¥æ–°çš„ Day æ¨™é¡Œï¼');
            return;
        }

        dayCounter++;
        const newDayId = `day${dayCounter}`;

        // 1. æ–°å¢ Tab Button
        const tabBar = document.getElementById('tabBar');
        const newButton = document.createElement('button');
        newButton.classList.add('tab-button');
        newButton.setAttribute('data-tab-id', newDayId);
        newButton.textContent = newTitle;
        newButton.addEventListener('click', function() {
            switchTab(this.getAttribute('data-tab-id'));
        });

        // æ’å…¥åœ¨æœ€å¾Œä¸€å€‹ Day å’Œ Stat Tab ä¹‹é–“
        let insertBeforeElement = document.querySelector('.tab-button[data-tab-id="stats"]');
        let nextElement = document.querySelector('.tab-button[data-tab-id^="day"]:last-of-type');
        if(nextElement) {
            insertBeforeElement = nextElement.nextElementSibling;
        }
        if (insertBeforeElement) {
            tabBar.insertBefore(newButton, insertBeforeElement);
        } else {
            tabBar.appendChild(newButton);
        }

        // 2. æ–°å¢ Tab Content
        const itinerarySection = document.getElementById('itinerarySection');
        const newContent = document.createElement('div');
        newContent.classList.add('tab-content');
        newContent.setAttribute('data-tab-content-id', newDayId);

        let contentInsertBefore = document.querySelector('.tab-content[data-tab-content-id="stats"]');
        let day12Content = document.querySelector('.tab-content[data-tab-content-id="day12"]');
        if (day12Content) {
            contentInsertBefore = day12Content.nextElementSibling;
            while(contentInsertBefore && contentInsertBefore.getAttribute('data-tab-content-id').startsWith('day')) {
                contentInsertBefore = contentInsertBefore.nextElementSibling;
            }
        }
        if (contentInsertBefore && contentInsertBefore.parentElement === itinerarySection) {
            itinerarySection.insertBefore(newContent, contentInsertBefore);
        } else {
            itinerarySection.appendChild(newContent);
        }
        
        // 3. åˆå§‹åŒ–æ•¸æ“šã€æ¸…ç©ºè¼¸å…¥ä¸¦åˆ‡æ›
        ITINERARY[newDayId] = [];
        titleInput.value = '';
        loadDaySelector();
        switchTab(newDayId);
        saveData();
    }

    // æ–°å¢ç•¶æ—¥æ´»å‹•
    function addActivityToDay() {
        const dayId = document.getElementById('daySelector').value;
        const activityTime = document.getElementById('newActivityTime').value.trim();
        const activityDescription = document.getElementById('newActivityDescription').value.trim();
        const activityType = document.getElementById('newActivityType').value;
        const mapUrlOverride = document.getElementById('newActivityMapUrl').value.trim();

        if (!dayId || !activityTime || !activityDescription) {
            alert('è«‹å¡«å¯«æ—¥æœŸã€æ™‚é–“/æ¨™é¡Œå’Œæ´»å‹•æè¿°ï¼');
            return;
        }

        const newActivity = {
            id: Date.now(),
            time: activityTime,
            description: activityDescription,
            type: activityType,
            mapUrlOverride: mapUrlOverride.startsWith('http') ? mapUrlOverride : ''
        };

        // å„²å­˜åˆ° ITINERARY æ•¸æ“šçµæ§‹
        if (!ITINERARY[dayId]) {
            ITINERARY[dayId] = [];
        }
        ITINERARY[dayId].push(newActivity);

        // æ¸²æŸ“åˆ°é é¢
        const targetContent = document.querySelector(`.tab-content[data-tab-content-id="${dayId}"]`);
        const cardHtml = createActivityCardHtml(newActivity, dayId);
        targetContent.insertAdjacentHTML('afterbegin', cardHtml);

        // æ¸…ç©ºè¼¸å…¥
        document.getElementById('newActivityTime').value = '';
        document.getElementById('newActivityDescription').value = '';
        document.getElementById('newActivityMapUrl').value = '';

        // é‡æ–°åˆå§‹åŒ–å¯ç·¨è¼¯å…§å®¹çš„äº‹ä»¶
        initEditableContent(); 
        updateAllMapLinks(); // æ›´æ–°åœ°åœ–é€£çµ
        saveData();
    }

    // ====================================
    // è²»ç”¨æ¸…å–®åŠŸèƒ½
    // ====================================

    // æ ¹æ“šé¡åˆ¥ç²å– Emoji
    function getCategoryEmoji(category) {
        switch (category) {
            case 'é£²é£Ÿ': return 'ğŸ•';
            case 'äº¤é€š': return 'âœˆï¸';
            case 'ä½å®¿': return 'ğŸ¨';
            case 'è³¼ç‰©': return 'ğŸ›ï¸';
            case 'æ´»å‹•': return 'â›·ï¸';
            case 'å…¶ä»–': return 'â“';
            default: return 'â“';
        }
    }

    // ç²å–ç•¶å‰åŒ¯ç‡
    function getCurrentExchangeRate() {
        const rate = parseFloat(document.getElementById('currentExchangeRate').value);
        return isNaN(rate) || rate <= 0 ? 3.00 : rate;
    }

    // æ–°å¢æ”¯å‡º
    function addExpense() {
        const date = document.getElementById('expenseDate').value;
        const category = document.getElementById('expenseCategory').value;
        const description = document.getElementById('expenseDescription').value.trim();
        const amountNOK = parseFloat(document.getElementById('expenseAmountNOK').value);
        const rate = getCurrentExchangeRate();

        if (!date || !description || isNaN(amountNOK) || amountNOK <= 0) {
            alert('è«‹å¡«å¯«å®Œæ•´æ—¥æœŸã€æè¿°å’ŒæŒªå¨å…‹æœ—é‡‘é¡ï¼');
            return;
        }

        const amountNTD = Math.round(amountNOK * rate);

        const newExpense = {
            date: date,
            category: category,
            description: description,
            amountNOK: amountNOK,
            amountNTD: amountNTD,
            exchangeRate: rate
        };

        EXPENSES.push(newExpense); // æ¨å…¥åˆ°æ•¸æ“šçµæ§‹

        // æ¸²æŸ“åˆ° DOM
        const expenseCard = document.createElement('div');
        expenseCard.classList.add('expense-card');
        
        // å„²å­˜æ•¸æ“šå±¬æ€§ï¼Œç”¨æ–¼ç¯©é¸å’Œæ’åº
        expenseCard.setAttribute('data-category', category);
        expenseCard.setAttribute('data-amount', amountNTD);
        expenseCard.setAttribute('data-nok', amountNOK);
        expenseCard.setAttribute('data-rate', rate.toFixed(2));
        const dateObj = new Date(date);
        const dateStr = `${dateObj.getMonth() + 1}/${dateObj.getDate()}`;
        expenseCard.setAttribute('data-date-str', dateStr);
        expenseCard.setAttribute('data-iso-date', date);

        const emoji = getCategoryEmoji(category);
        expenseCard.innerHTML = `
            <span class="card-icon">${emoji}</span>
            <div class="card-main-info">
                <div class="card-description">${description}</div>
                <div class="card-meta">${category} Â· ${dateStr} (åŒ¯ç‡ ${rate.toFixed(2)})</div>
            </div>
            <div class="card-amounts">
                <div class="amount-ntd">NTD ${amountNTD.toLocaleString('en-US')}</div>
                <div class="amount-nok">NOK ${amountNOK.toLocaleString('en-US')}</div>
            </div>
            <button class="delete-card-btn" onclick="deleteCard(this)">åˆªé™¤</button>
        `;

        document.getElementById('expenseBody').prepend(expenseCard);

        // æ¸…ç©ºè¼¸å…¥
        document.getElementById('expenseAmountNOK').value = '';
        document.getElementById('expenseDescription').value = '';

        sortAndFilterExpenses();
        saveData();
    }

    // æ›´æ–°ç¸½è¨ˆ
    function updateTotal() {
        let totalNTD = 0;
        let totalNOK = 0;
        
        // å¾ DOM ä¸­è®€å–æ‰€æœ‰å¯è¦‹çš„ expense-card
        const visibleCards = document.querySelectorAll('#expenseBody .expense-card[style*="flex"]');
        
        visibleCards.forEach(card => {
            totalNTD += parseInt(card.getAttribute('data-amount'));
            totalNOK += parseFloat(card.getAttribute('data-nok'));
        });

        document.getElementById('totalAmount').textContent = totalNTD.toLocaleString('en-US');
        document.getElementById('totalNokAmount').textContent = Math.round(totalNOK).toLocaleString('en-US');
    }

    // åˆªé™¤å¡ç‰‡ (é€šç”¨)
    function deleteCard(btn) {
        if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è³‡æ–™å—ï¼Ÿ')) return;
        const card = btn.parentNode;

        if (card.classList.contains('expense-card')) {
            // è™•ç†è²»ç”¨æ¸…å–®çš„åˆªé™¤
            const amount = parseInt(card.getAttribute('data-amount'));
            const nok = parseFloat(card.getAttribute('data-nok'));
            
            // å¾ EXPENSES æ•¸æ“šçµæ§‹ä¸­ç§»é™¤
            const date = card.getAttribute('data-iso-date');
            const description = card.querySelector('.card-description').textContent;
            EXPENSES = EXPENSES.filter(e => !(
                e.date === date && 
                e.amountNOK === nok && 
                e.description === description
            ));

            card.parentNode.removeChild(card);
            updateTotal();
        } else { 
            // è™•ç†æ‰“åŒ…æ¸…å–®/æ–‡ä»¶æ¸…å–®çš„åˆªé™¤
            card.parentNode.removeChild(card);
        }
        
        saveData();
    }

    // æ’åºå’Œç¯©é¸è²»ç”¨
    function sortAndFilterExpenses() {
        const container = document.getElementById('expenseBody');
        let cards = Array.from(container.querySelectorAll('.expense-card'));
        const filterCriteria = document.getElementById('expenseFilter').value;
        const sortCriteria = document.getElementById('expenseSort').value;

        // 1. ç¯©é¸
        cards.forEach(card => {
            const category = card.getAttribute('data-category');
            const isVisible = filterCriteria === 'all' || category === filterCriteria;
            card.style.display = isVisible ? 'flex' : 'none';
        });

        let visibleCards = cards.filter(card => card.style.display !== 'none');

        // 2. æ’åº
        visibleCards.sort((a, b) => {
            const amountA = parseInt(a.getAttribute('data-amount'));
            const amountB = parseInt(b.getAttribute('data-amount'));
            const dateA = a.getAttribute('data-iso-date');
            const dateB = b.getAttribute('data-iso-date');
            const categoryA = a.getAttribute('data-category');
            const categoryB = b.getAttribute('data-category');

            switch (sortCriteria) {
                case 'date_desc':
                    return dateB.localeCompare(dateA);
                case 'date_asc':
                    return dateA.localeCompare(dateB);
                case 'ntd_desc':
                    return amountB - amountA;
                case 'ntd_asc':
                    return amountA - amountB;
                case 'category_asc':
                    return categoryA.localeCompare(categoryB);
                default:
                    return 0;
            }
        });

        // 3. é‡æ–°æ’å…¥ DOM (ä¿ç•™éå¯è¦‹çš„å¡ç‰‡åœ¨åŸä½)
        visibleCards.forEach(card => container.appendChild(card));
        
        updateTotal(); // æ›´æ–°ç¸½è¨ˆ (åªè¨ˆç®—å¯è¦‹çš„)
    }

    // ===================================
    // æ”¯å‡ºçµ±è¨ˆåŠŸèƒ½
    // ===================================
    function generateExpenseStatsTable() {
        const container = document.getElementById('expenseStatsContainer');
        if (!container) return;
        
        const categoryTotals = {};
        let grandTotalNTD = 0;

        // è¨ˆç®—æ¯å€‹é¡åˆ¥çš„ç¸½é¡
        EXPENSES.forEach(expense => {
            const category = expense.category;
            const amount = expense.amountNTD;
            categoryTotals[category] = (categoryTotals[category] || 0) + amount;
            grandTotalNTD += amount;
        });

        if (grandTotalNTD === 0) {
            container.innerHTML = '<p style="color: #9b7673; font-weight: bold;">ç›®å‰æ²’æœ‰ä»»ä½•æ”¯å‡ºè¨˜éŒ„ã€‚</p>';
            return;
        }

        let tableHtml = `
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>é¡åˆ¥</th>
                        <th style="text-align: right;">é‡‘é¡ (NTD)</th>
                        <th>ä½”ç¸½é¡ç™¾åˆ†æ¯”</th>
                    </tr>
                </thead>
                <tbody>
        `;

        // æ’åºé¡åˆ¥åç¨±
        const sortedCategories = Object.keys(categoryTotals).sort();

        // å¡«å……è¡¨æ ¼å…§å®¹
        sortedCategories.forEach(category => {
            const total = categoryTotals[category];
            const percentage = ((total / grandTotalNTD) * 100).toFixed(1);
            tableHtml += `
                <tr>
                    <td>${getCategoryEmoji(category)} ${category}</td>
                    <td style="text-align: right;">${total.toLocaleString('en-US')}</td>
                    <td class="percentage-cell">${percentage}%</td>
                </tr>
            `;
        });

        tableHtml += `
            <tr class="total-row">
                <td>ç¸½è¨ˆ</td>
                <td style="text-align: right;">${grandTotalNTD.toLocaleString('en-US')}</td>
                <td class="percentage-cell">100.0%</td>
            </tr>
        </tbody>
        </table>
        `;
        container.innerHTML = tableHtml;
    }

    // ===================================
    // æ‰“åŒ…æ¸…å–®ç®¡ç†åŠŸèƒ½
    // ===================================
    function addPackingItem() {
        const itemText = document.getElementById('packingItem').value.trim();
        if (itemText === '') {
            alert('è«‹è¼¸å…¥ç‰©å“åç¨±ã€‚');
            return;
        }

        const newItemData = { description: itemText, checked: false };
        PACKING_LIST.push(newItemData); // å„²å­˜åˆ°æ•¸æ“šçµæ§‹

        const packingList = document.getElementById('packingList');
        const newItem = document.createElement('div');
        newItem.classList.add('packing-item');
        newItem.setAttribute('data-checked', 'false');

        newItem.innerHTML = `
            <div class="card-main-info" onclick="togglePackingCheck(this.parentNode)">
                <div class="card-description">${itemText}</div>
            </div>
            <button class="delete-card-btn" onclick="event.stopPropagation(); deleteCard(this)">åˆªé™¤</button>
        `;
        packingList.appendChild(newItem);

        document.getElementById('packingItem').value = '';
        saveData();
    }

    // æ‰“åŒ…æ¸…å–® - åˆ‡æ›å‹¾é¸ç‹€æ…‹
    function togglePackingCheck(item) {
        const isChecked = item.getAttribute('data-checked') === 'true';
        item.setAttribute('data-checked', isChecked ? 'false' : 'true');
        item.classList.toggle('checked');

        // æ›´æ–° PACKING_LIST æ•¸æ“š
        const description = item.querySelector('.card-description').textContent;
        const itemData = PACKING_LIST.find(d => d.description === description);
        if (itemData) {
            itemData.checked = !isChecked;
        }
        
        saveData();
    }

    // ===================================
    // æ–‡ä»¶æ¸…å–®ç®¡ç†åŠŸèƒ½
    // ===================================
    // æ–‡ä»¶æ¸…å–® - æ–°å¢æ–‡ä»¶
    function addDocument() {
        const title = document.getElementById('docTitle').value.trim();
        const link = document.getElementById('docLink').value.trim();

        if (title === '') {
            alert('è«‹è¼¸å…¥æ–‡ä»¶æ¨™é¡Œã€‚');
            return;
        }

        if (link !== '' && !link.startsWith('http')) {
            alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„ URL é€£çµ (éœ€åŒ…å« http:// æˆ– https://)ã€‚');
            return;
        }

        const newDocData = { title: title, link: link };
        DOCUMENTS.push(newDocData); // å„²å­˜åˆ°æ•¸æ“šçµæ§‹

        const documentList = document.getElementById('documentList');
        const newCard = document.createElement('div');
        newCard.classList.add('document-card');
        newCard.setAttribute('data-doc-title', title);
        newCard.setAttribute('data-doc-link', link);

        const linkHTML = link !== '' ? `<a href="${link}" target="_blank" class="doc-link">ğŸ”— æŸ¥çœ‹æ–‡ä»¶</a>` : `<span class="doc-link" style="color:#999; cursor:default;">ç„¡é€£çµ</span>`;

        newCard.innerHTML = `
            <div class="document-title">${title}</div>
            <div style="display: flex; gap: 10px; align-items: center;">
                ${linkHTML}
                <button class="delete-card-btn" onclick="deleteCard(this)">åˆªé™¤</button>
            </div>
        `;

        documentList.appendChild(newCard);

        document.getElementById('docTitle').value = '';
        document.getElementById('docLink').value = '';
        saveData();
    }


    // ====================================
    // è³‡æ–™å„²å­˜èˆ‡è¼‰å…¥
    // ====================================

    // ç²å–è²»ç”¨æ¸…å–®çš„çµæ§‹åŒ–è³‡æ–™
    function getExpenseData() {
        return EXPENSES;
    }

    // ç²å–è¡Œç¨‹æ¸…å–®çš„çµæ§‹åŒ–è³‡æ–™ (å¾ DOM ä¸­æ›´æ–° ITINERARY æ•¸æ“š)
    function getItineraryData() {
        // ç¢ºä¿ ITINERARY çµæ§‹èˆ‡ç•¶å‰ DOM ç‹€æ…‹åŒæ­¥
        ITINERARY_TABS.forEach(tab => {
            const dayId = tab.id;
            const activities = [];
            const cards = document.querySelectorAll(`.tab-content[data-tab-content-id="${dayId}"] .activity-card`);
            
            cards.forEach(card => {
                const activityId = parseInt(card.getAttribute('data-activity-id'));
                const activityTime = card.querySelector('.card-time').textContent.trim();
                const activityDescription = card.querySelector('.editable-content').innerHTML.trim(); // ä½¿ç”¨ innerHTML ç²å–é«˜äº®æ¨™ç±¤
                const activityType = card.getAttribute('data-type');
                
                // å˜—è©¦å¾ ITINERARY æ‰¾åˆ°å·²å„²å­˜çš„ mapUrlOverride
                const existingActivity = ITINERARY[dayId] ? ITINERARY[dayId].find(a => a.id === activityId) : null;
                const mapUrlOverride = existingActivity ? existingActivity.mapUrlOverride : ""; 

                activities.push({
                    id: activityId,
                    time: activityTime,
                    description: activityDescription,
                    type: activityType,
                    mapUrlOverride: mapUrlOverride // å„²å­˜ override é€£çµï¼Œè€Œä¸æ˜¯å¾ DOM è®€å–
                });
            });
            ITINERARY[dayId] = activities;
        });
        return ITINERARY;
    }

    // ç²å–æ‰“åŒ…æ¸…å–®çš„çµæ§‹åŒ–è³‡æ–™
    function getPackingData() {
        // ç¢ºä¿ PACKING_LIST æ•¸æ“šçµæ§‹èˆ‡ DOM åŒæ­¥
        return Array.from(document.querySelectorAll('#packingList .packing-item')).map(item => ({
            description: item.querySelector('.card-description').textContent,
            checked: item.getAttribute('data-checked') === 'true'
        }));
    }

    // ç²å–æ–‡ä»¶æ¸…å–®çš„çµæ§‹åŒ–è³‡æ–™
    function getDocumentData() {
         // ç¢ºä¿ DOCUMENTS æ•¸æ“šçµæ§‹èˆ‡ DOM åŒæ­¥
        return Array.from(document.querySelectorAll('#documentList .document-card')).map(card => ({
            title: card.getAttribute('data-doc-title'),
            link: card.getAttribute('data-doc-link')
        }));
    }

    // å„²å­˜è³‡æ–™åˆ° Local Storage
    function saveData() {
        const expensesData = getExpenseData();
        // å¾ DOM ä¸­é‡æ–°è®€å–æœ€æ–°çš„é ç±¤åˆ—è¡¨
        const itineraryTabs = Array.from(document.querySelectorAll('.tab-button[data-tab-id^="day"]')).map(button => ({ 
            id: button.getAttribute('data-tab-id'), 
            title: button.textContent 
        }));
        const packingListData = getPackingData();
        const documentData = getDocumentData();
        const currentRate = getCurrentExchangeRate();

        const data = {
            expenses: expensesData,
            itinerary: getItineraryData(), // å‘¼å«æ­¤è™•ä»¥æ›´æ–° ITINERARY çµæ§‹
            itineraryTabs: itineraryTabs,
            dayCounter: dayCounter,
            packing: packingListData,
            documents: documentData,
            exchangeRate: currentRate
        };

        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            document.getElementById('lastSaveTime').textContent = new Date().toLocaleString('zh-TW');
        } catch (e) {
            console.error('å„²å­˜è³‡æ–™å¤±æ•—:', e);
            // alert('å„²å­˜è³‡æ–™å¤±æ•— (ç€è¦½å™¨å„²å­˜ç©ºé–“ä¸è¶³æˆ–éš±ç§è¨­å®šå•é¡Œ)ã€‚');
        }
    }

    // å¾ Local Storage è¼‰å…¥è³‡æ–™
    function loadData() {
        const dataString = localStorage.getItem(STORAGE_KEY);
        const rateInput = document.getElementById('currentExchangeRate');

        if (!dataString) {
            document.getElementById('lastSaveTime').textContent = 'ç„¡å„²å­˜è³‡æ–™';
            if (rateInput) { rateInput.value = "3.00"; }
            updateTotal(); 
            generateExpenseStatsTable();
            loadDaySelector();
            initEditableContent(); // åˆå§‹åŒ–é è¨­å…§å®¹çš„ç·¨è¼¯äº‹ä»¶
            updateAllMapLinks(); // åˆå§‹åŒ–é è¨­å…§å®¹çš„åœ°åœ–é€£çµé¡¯ç¤º
            return;
        }

        try {
            const data = JSON.parse(dataString);
            
            // é©—è­‰æ ¸å¿ƒæ•¸æ“šçµæ§‹
            if (!data.expenses || !data.itinerary || !data.itineraryTabs || !data.dayCounter) {
                throw new Error("è³‡æ–™çµæ§‹ä¸å®Œæ•´ï¼Œå°‡é‡ç½®ç‚ºé è¨­å€¼ã€‚");
            }

            // 1. è¼‰å…¥è²»ç”¨æ¸…å–®
            EXPENSES = data.expenses || DEFAULT_EXPENSES;
            document.getElementById('expenseBody').innerHTML = '';
            EXPENSES.forEach(expense => {
                const expenseCard = document.createElement('div');
                expenseCard.classList.add('expense-card');
                
                // ç¢ºä¿æ•¸å€¼æœ‰æ•ˆ
                const amountNTD = expense.amountNTD || Math.round(expense.amountNOK * expense.exchangeRate) || 0;
                const amountNOK = expense.amountNOK || 0;
                const rate = expense.exchangeRate || 3.00;

                expenseCard.setAttribute('data-category', expense.category || 'å…¶ä»–');
                expenseCard.setAttribute('data-amount', amountNTD);
                expenseCard.setAttribute('data-nok', amountNOK);
                expenseCard.setAttribute('data-rate', rate.toFixed(2));
                const dateObj = new Date(expense.date);
                const dateStr = `${dateObj.getMonth() + 1}/${dateObj.getDate()}`;
                expenseCard.setAttribute('data-date-str', dateStr);
                expenseCard.setAttribute('data-iso-date', expense.date || '');

                const emoji = getCategoryEmoji(expense.category);
                expenseCard.innerHTML = `
                    <span class="card-icon">${emoji}</span>
                    <div class="card-main-info">
                        <div class="card-description">${expense.description || 'ç„¡æè¿°'}</div>
                        <div class="card-meta">${expense.category || 'å…¶ä»–'} Â· ${dateStr} (åŒ¯ç‡ ${rate.toFixed(2)})</div>
                    </div>
                    <div class="card-amounts">
                        <div class="amount-ntd">NTD ${amountNTD.toLocaleString('en-US')}</div>
                        <div class="amount-nok">NOK ${amountNOK.toLocaleString('en-US')}</div>
                    </div>
                    <button class="delete-card-btn" onclick="deleteCard(this)">åˆªé™¤</button>
                `;
                document.getElementById('expenseBody').appendChild(expenseCard);
            });

            // 2. è¼‰å…¥è¡Œç¨‹é ç±¤
            ITINERARY = data.itinerary || ITINERARY;
            ITINERARY_TABS = data.itineraryTabs || DEFAULT_TABS;
            dayCounter = data.dayCounter || 12;

            // æ¸…ç©ºé è¨­çš„ Day Tabs
            const tabBar = document.getElementById('tabBar');
            const itinerarySection = document.getElementById('itinerarySection');
            
            document.querySelectorAll('.tab-button[data-tab-id^="day"], .tab-content[data-tab-content-id^="day"]').forEach(el => el.remove());

            // é‡æ–°å»ºç«‹ Day Tabs å’Œ Content
            ITINERARY_TABS.forEach(tab => {
                
                // âš ï¸ [æ–°å¢] è³‡æ–™ç©©å®šæ€§æª¢æŸ¥ï¼šç¢ºä¿ tab id å’Œ title æœ‰æ•ˆï¼Œé˜²æ­¢ DOMTokenList éŒ¯èª¤
                if (!tab.id || !tab.title || typeof tab.id !== 'string' || tab.id.trim() === '') {
                    console.warn('è­¦å‘Šï¼šåµæ¸¬åˆ°æå£çš„ Tab è³‡æ–™ï¼Œå·²è·³éæ­¤é …ç›®ã€‚', tab);
                    return; // è·³éç„¡æ•ˆçš„ tabï¼Œé˜²æ­¢ç¨‹å¼å´©æ½°
                }
                
                // 1. æ–°å¢ Tab Button
                const newButton = document.createElement('button');
                newButton.classList.add('tab-button');
                newButton.setAttribute('data-tab-id', tab.id);
                newButton.textContent = tab.title;
                newButton.addEventListener('click', function() {
                    switchTab(this.getAttribute('data-tab-id'));
                });

                // æ’å…¥åœ¨æœ€å¾Œä¸€å€‹ Day å’Œ Stat Tab ä¹‹é–“
                let insertBeforeElement = document.querySelector('.tab-button[data-tab-id="stats"]');
                tabBar.insertBefore(newButton, insertBeforeElement);

                // 2. æ–°å¢ Tab Content
                const tabContent = document.createElement('div');
                tabContent.classList.add('tab-content');
                tabContent.setAttribute('data-tab-content-id', tab.id);
                
                let contentInsertBefore = document.querySelector('.tab-content[data-tab-content-id="stats"]');
                itinerarySection.insertBefore(tabContent, contentInsertBefore);

                // å¡«å……æ´»å‹•å…§å®¹
                if (ITINERARY[tab.id]) {
                    ITINERARY[tab.id].forEach(activity => {
                        // ç¢ºä¿è¼‰å…¥çš„æ´»å‹•æœ‰åœ°åœ–è¦†è“‹æ¬„ä½
                        if (activity.mapUrlOverride === undefined) activity.mapUrlOverride = "";
                        tabContent.insertAdjacentHTML('beforeend', createActivityCardHtml(activity, tab.id));
                    });
                }
            });

            // 3. è¼‰å…¥æ‰“åŒ…æ¸…å–®
            PACKING_LIST = data.packing || [];
            const packingList = document.getElementById('packingList');
            packingList.innerHTML = '';
            PACKING_LIST.forEach(item => {
                const isChecked = item.checked ? 'true' : 'false';
                const classChecked = item.checked ? 'checked' : '';
                const newItem = document.createElement('div');
                newItem.classList.add('packing-item', classChecked);
                newItem.setAttribute('data-checked', isChecked);
                
                newItem.innerHTML = `
                    <div class="card-main-info" onclick="togglePackingCheck(this.parentNode)">
                        <div class="card-description">${item.description || 'ç„¡æè¿°'}</div>
                    </div>
                    <button class="delete-card-btn" onclick="event.stopPropagation(); deleteCard(this)">åˆªé™¤</button>
                `;
                packingList.appendChild(newItem);
            });

            // 4. è¼‰å…¥æ–‡ä»¶æ¸…å–®
            DOCUMENTS = data.documents || [];
            const documentList = document.getElementById('documentList');
            documentList.innerHTML = '';
            DOCUMENTS.forEach(doc => {
                 const newCard = document.createElement('div');
                 newCard.classList.add('document-card');
                 newCard.setAttribute('data-doc-title', doc.title || 'ç„¡æ¨™é¡Œ');
                 newCard.setAttribute('data-doc-link', doc.link || '');
                 
                 const linkHTML = doc.link && doc.link.startsWith('http') ? 
                                  `<a href="${doc.link}" target="_blank" class="doc-link">ğŸ”— æŸ¥çœ‹æ–‡ä»¶</a>` : 
                                  `<span class="doc-link" style="color:#999; cursor:default;">ç„¡é€£çµ</span>`;

                newCard.innerHTML = `
                    <div class="document-title">${doc.title || 'ç„¡æ¨™é¡Œ'}</div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        ${linkHTML}
                        <button class="delete-card-btn" onclick="deleteCard(this)">åˆªé™¤</button>
                    </div>
                `;
                documentList.appendChild(newCard);
            });


            // 5. è¼‰å…¥åŒ¯ç‡
            if (rateInput && data.exchangeRate) {
                rateInput.value = data.exchangeRate;
            }
            
            // 6. æ›´æ–°ç¸½è¨ˆã€é¸æ“‡å™¨ã€ç·¨è¼¯äº‹ä»¶
            sortAndFilterExpenses(); // è¼‰å…¥å¾Œå…ˆåŸ·è¡Œä¸€æ¬¡ç¯©é¸æ’åºå’Œç¸½è¨ˆ
            loadDaySelector();
            initEditableContent();
            updateAllMapLinks(); // æ›´æ–°åœ°åœ–é€£çµ
            
            document.getElementById('lastSaveTime').textContent = new Date().toLocaleString('zh-TW');

        } catch (e) {
            console.error('è¼‰å…¥è³‡æ–™å¤±æ•—ï¼Œå·²é‡ç½®ç‚ºé è¨­å€¼:', e);
            alert('è¼‰å…¥è³‡æ–™å¤±æ•—ï¼Œè³‡æ–™å¯èƒ½å·²æå£ã€‚å·²é‡ç½®ç‚ºé è¨­å€¼ã€‚è«‹æª¢æŸ¥æ‚¨çš„ç€è¦½å™¨å„²å­˜ç©ºé–“ã€‚');
            
            // æ¸…ç† Local Storage ä¸­çš„éŒ¯èª¤è³‡æ–™ä¸¦ä½¿ç”¨é è¨­å€¼
            localStorage.removeItem(STORAGE_KEY);
            // é‡æ–°é‹è¡Œ loadData() ä»¥ä½¿ç”¨é è¨­å€¼
            // æ­¤è™•ä¸éœ€å†æ¬¡èª¿ç”¨ loadDataï¼Œå› ç‚ºç•¶å‰é é¢å·²ç¶“æ˜¯é è¨­ DOM çµæ§‹ï¼Œåªéœ€åˆå§‹åŒ–æ•¸æ“š
            EXPENSES = DEFAULT_EXPENSES;
            ITINERARY = { 
                "day1": [{ id: 1703271600000, time: "15:30", description: "æ­ä¹˜æ©Ÿå ´å·´å£«å‰å¾€é£¯åº—", type: "transport", mapUrlOverride: "" }, { id: 1703271600001, time: "ä½å®¿", description: "Radisson Blu Hotel, TromsÃ¸ (å·²é è¨‚)", type: "lodging", mapUrlOverride: "" }],
                "day2": [{ id: 1703271600002, time: "09:00", description: "åƒè§€ <span class='highlight'>ç‰¹ç¾…å§†ç‘Ÿåšç‰©é¤¨ (TromsÃ¸ Museum)</span>", type: "activity", mapUrlOverride: "" }, { id: 1703271600003, time: "13:00", description: "åˆé¤ï¼šè©¦è©¦åŒ—æ¥µæµ·é®®æ¹¯", type: "activity", mapUrlOverride: "" }, { id: 1703271600004, time: "19:00", description: "åŒ—æ¥µå…‰è¿½é€ä¹‹æ—… (å·²é è¨‚)", type: "activity", mapUrlOverride: "" }],
                "day3": [], "day4": [], "day5": [], "day6": [], "day7": [], "day8": [], "day9": [], "day10": [], "day11": [], "day12": [] 
            };
            ITINERARY_TABS = DEFAULT_TABS;
            dayCounter = 12;
            PACKING_LIST = [];
            DOCUMENTS = [];

            if (rateInput) { rateInput.value = "3.00"; }
            updateTotal(); 
            generateExpenseStatsTable();
            loadDaySelector();
            initEditableContent();
            updateAllMapLinks();
            document.getElementById('lastSaveTime').textContent = 'ç„¡å„²å­˜è³‡æ–™ (å·²é‡ç½®)';
            
            // ç”±æ–¼ DOM å·²ç¶“æ˜¯é è¨­ï¼Œåªéœ€è¦å„²å­˜ä¸€æ¬¡ä¹¾æ·¨çš„é è¨­å€¼
            saveData(); 
            
            // é‡æ–°è¼‰å…¥é é¢ (ç¢ºä¿ä½¿ç”¨è€…çœ‹åˆ°ä¹¾æ·¨çš„é é¢)
            // location.reload(); 
        }
    }


    // ====================================
    // è³‡æ–™åŒ¯å‡ºèˆ‡åŒ¯å…¥ (Backup/Restore)
    // ====================================
    
    // åŒ¯å‡ºè³‡æ–™ (è¤‡è£½åˆ°å‰ªè²¼æ¿)
    function exportData() {
        const rawData = localStorage.getItem(STORAGE_KEY);
        
        if (!rawData) {
            alert('æ²’æœ‰å„²å­˜çš„è³‡æ–™å¯ä»¥åŒ¯å‡ºã€‚');
            return;
        }

        try {
            const data = JSON.parse(rawData);
            const formattedData = JSON.stringify(data, null, 2);
            
            navigator.clipboard.writeText(formattedData).then(() => {
                alert('å‚™ä»½è³‡æ–™ (JSON æ ¼å¼) å·²æˆåŠŸè¤‡è£½åˆ°å‰ªè²¼æ¿ï¼\næ‚¨å¯ä»¥å°‡å…¶è²¼åˆ°ç­†è¨˜æœ¬æˆ–æ–‡ä»¶ä¸­å„²å­˜ã€‚');
            }).catch(err => {
                console.error('è¤‡è£½å¤±æ•—: ', err);
                alert('è¤‡è£½åˆ°å‰ªè²¼æ¿å¤±æ•—ï¼Œè«‹æŸ¥çœ‹æ§åˆ¶å°éŒ¯èª¤ã€‚');
            });
            
        } catch (e) {
            alert('å„²å­˜çš„è³‡æ–™æ ¼å¼ä¸æ­£ç¢ºï¼Œç„¡æ³•åŒ¯å‡ºã€‚');
        }
    }

    // è¼‰å…¥è³‡æ–™ (å¾è¼¸å…¥æ¡†)
    function importData() {
        const backupData = prompt("è«‹è²¼ä¸Šæ‚¨çš„å‚™ä»½è³‡æ–™ (JSON æ ¼å¼):\n\næ³¨æ„ï¼šé€™å°‡æœƒè¦†è“‹æ‚¨ç•¶å‰å„²å­˜åœ¨ç€è¦½å™¨ä¸­çš„æ‰€æœ‰æ•¸æ“šï¼");
        
        if (backupData === null || backupData.trim() === '') {
            return; 
        }

        try {
            const data = JSON.parse(backupData);
            
            // ç°¡å–®é©—è­‰çµæ§‹
            if (!data.expenses || !data.itinerary || !data.dayCounter) {
                throw new Error('è³‡æ–™çµæ§‹ä¸å®Œæ•´ã€‚');
            }

            // å­˜å…¥ Local Storage ä¸¦é‡æ–°è¼‰å…¥
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            alert('è³‡æ–™å·²æˆåŠŸåŒ¯å…¥ï¼é é¢å°‡é‡æ–°è¼‰å…¥ã€‚');
            location.reload();
            
        } catch (e) {
            alert('åŒ¯å…¥å¤±æ•—ï¼šæ‚¨è²¼ä¸Šçš„å…§å®¹ä¸æ˜¯æœ‰æ•ˆçš„ JSON æ ¼å¼æˆ–è³‡æ–™çµæ§‹ä¸å®Œæ•´ã€‚è«‹æª¢æŸ¥å¾Œå†è©¦ã€‚');
            console.error('åŒ¯å…¥éŒ¯èª¤:', e);
        }
    }

</script>
</body>

</html>
